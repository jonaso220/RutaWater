<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RutaWater - Gesti√≥n de Reparto</title>

    <!-- CONFIGURACI√ìN PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">

    <!-- PRECONNECT: acelerar carga de CDNs -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">

    <!-- ENLACE AL MANIFIESTO EXTERNO -->
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/jpeg" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <!-- Estilos: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', // Se activa autom√°ticamente seg√∫n la configuraci√≥n del sistema
        }
    </script>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* Reset b√°sico */
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
        }
        input, select, textarea { font-size: 16px; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estilos Sortable */
        .sortable-ghost { opacity: 0.4; background-color: #eff6ff; } 
        @media (prefers-color-scheme: dark) {
            .sortable-ghost { background-color: #374151; opacity: 0.5; }
        }
        .sortable-drag { cursor: grabbing; background-color: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: scale(1.02); z-index: 50; }
        @media (prefers-color-scheme: dark) {
             .sortable-drag { background-color: #1f2937; }
        }
        .drag-handle { cursor: grab; touch-action: pan-y; }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast-animate { animation: slideUpFade 0.3s ease-out forwards; }
        
        /* Animaci√≥n de Campana */
        @keyframes ring {
            0% { transform: rotate(0); } 10% { transform: rotate(30deg); } 30% { transform: rotate(-28deg); } 50% { transform: rotate(34deg); } 70% { transform: rotate(-32deg); } 90% { transform: rotate(30deg); } 100% { transform: rotate(0); }
        }
        .bell-ring { animation: ring 4s .7s ease-in-out infinite; }

        .order-input {
            width: 32px; height: 32px; text-align: center; border: none; border-radius: 8px; 
            font-weight: 700; font-size: 0.95rem; color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 2px 5px -1px rgba(37, 99, 235, 0.4);
            outline: none; padding: 0; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); -moz-appearance: textfield; 
        }
        .order-input:focus { transform: scale(1.1); box-shadow: 0 0 0 2px rgba(191, 219, 254, 0.5); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <div id="root"></div>

    <!-- REGISTRO DEL SERVICE WORKER -->
    <script type="text/javascript">
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('SW error', err));
            });
        }
    </script>

    <script type="text/babel">
        // --- CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJqRYt4lbsb3bOnmnDc5H6W6oJmjr1Bnc",
            authDomain: "rutawater.firebaseapp.com",
            projectId: "rutawater",
            storageBucket: "rutawater.firebasestorage.app",
            messagingSenderId: "882759838026",
            appId: "1:882759838026:web:d37117edceed063880f9b3",
            measurementId: "G-DFLM3JFKZF"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- PERSISTENCIA OFFLINE: datos instant√°neos al recargar ---
        db.enablePersistence({ synchronizeTabs: true }).catch(function(err) {
            if (err.code !== 'failed-precondition' && err.code !== 'unimplemented') {
                console.error('Persistence error:', err);
            }
        });

        // --- CONSTANTES ---
        const PRODUCTS = [
            { id: 'b20', label: '20L', icon: 'üíß', short: '20L' },
            { id: 'b12', label: '12L', icon: 'üíß', short: '12L' },
            { id: 'b6', label: '6L', icon: 'üíß', short: '6L' },
            { id: 'soda', label: 'Soda', icon: 'üçæ', short: 'Soda' },
            { id: 'bombita', label: 'Bombita', icon: 'üñêÔ∏è', short: 'Bomb' },
            { id: 'disp_elec_new', label: 'Disp. Elec Nuevo', icon: '‚ö°', short: 'ElecN' },
            { id: 'disp_elec_chg', label: 'Disp. Elec Cambio', icon: '‚ö°', short: 'ElecC' },
            { id: 'disp_nat', label: 'Disp. Natural', icon: 'üçÉ', short: 'Nat' },
        ];

        // --- ICONOS ---
        const Icons = {
            Truck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M17.5 19c0-1.7-1.3-3-3-3c-1.1 0-2 .6-2.5 1.5L12 17.5"/><path d="M6 16a4 4 0 0 1 4-4h4"/><path d="M17.5 19H17a5 5 0 0 1-5-5a5 5 0 0 1 10 0a5 5 0 0 1-4.5 5"/></svg>,
            CloudOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M4 4l16 16"/><path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193"/><path d="M21.532 16.5A4.5 4.5 0 0 0 17.5 10h-1.79A7.008 7.008 0 0 0 10 5.07"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            MapPin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Phone: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            MessageCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Navigation: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Home: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Link: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Drag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            Package: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M12.89 1.45l8 4A2 2 0 0 1 22 7.24v9.53a2 2 0 0 1-1.11 1.79l-8 4a2 2 0 0 1-1.79 0l-8-4a2 2 0 0 1-1.1-1.8V7.24a2 2 0 0 1 1.11-1.79l8-4a2 2 0 0 1 1.78 0z"/><polyline points="2.32 6.16 12 11 21.68 6.16"/><line x1="12" y1="22.76" x2="12" y2="11"/></svg>,
            Droplet: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>,
            Box: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            Pin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4a2 2 0 0 0-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.06-.59-1.42z"/><circle cx="6.5" cy="6.5" r="1.5"/></svg>,
            PinFilled: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="currentColor" stroke="none" className={props.className}><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4a2 2 0 0 0-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.06-.59-1.42z"/><circle cx="6.5" cy="6.5" r="1.5" fill="white"/></svg>,
            Archive: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
            SquareCheck: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>,
            Clipboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
            Import: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Bell: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill={props.fill || "none"} stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            CreditCard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><polyline points="6 9 12 15 18 9"/></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", type = "button" }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 dark:bg-blue-700",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/30 dark:text-red-400",
                success: "bg-green-600 text-white hover:bg-green-700 dark:bg-green-700",
                whatsapp: "bg-green-500 text-white hover:bg-green-600 dark:bg-green-600",
                google: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:text-white dark:border-gray-600"
            };
            return (
                <button type={type} onClick={onClick} className={`px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Badge = ({ children, type, date }) => {
            let colors = '';
            let label = '';
            switch(type) {
                case 'weekly': colors = 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200'; label = 'Semanal'; break;
                case 'biweekly': colors = 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200'; label = 'Cada 2 Sem'; break;
                case 'triweekly': colors = 'bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-200'; label = 'Cada 3 Sem'; break;
                case 'monthly': colors = 'bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-200'; label = 'Cada 4 Sem'; break;
                case 'once': 
                    colors = 'bg-orange-100 text-orange-800 dark:bg-gray-800 dark:text-orange-300 dark:border dark:border-orange-500'; 
                    label = date ? `Una vez: ${date.split('-').reverse().join('/')}` : 'Una vez'; 
                    break;
                case 'on_demand': colors = 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-300'; label = 'Archivado'; break;
                default: colors = 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'; label = type;
            }
            return <span className={`text-xs px-2 py-1 rounded-full font-bold ${colors}`}>{label}</span>;
        };

        const LoadInput = ({ label, value, onChange }) => (
            <div className="flex flex-col">
                <label className="text-[10px] font-medium text-gray-500 dark:text-gray-400 mb-0.5 text-center">{label}</label>
                <input 
                    type="number" 
                    value={value || ''} 
                    onChange={e => onChange(e.target.value)} 
                    placeholder="0"
                    className="w-full p-1 text-center border rounded-md focus:ring-1 focus:ring-blue-500 outline-none text-base font-semibold text-gray-700 dark:text-white dark:bg-gray-700 dark:border-gray-600 h-8"
                />
            </div>
        );

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Eliminar", cancelText = "Cancelar", isDanger = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200" style={{zIndex: 100}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-xs w-full p-6">
                        <div className="flex flex-col items-center text-center mb-6">
                            <div className={`${isDanger ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400'} p-3 rounded-full mb-4`}>
                                <Icons.AlertTriangle />
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
                            <p className="text-sm text-gray-500 dark:text-gray-400">{message}</p>
                        </div>
                        <div className="flex gap-3">
                            <Button variant="secondary" onClick={onCancel} className="flex-1 text-sm">{cancelText}</Button>
                            <Button variant={isDanger ? "danger" : "primary"} onClick={onConfirm} className="flex-1 text-sm">{confirmText}</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ message, onUndo, hasUndo }) => (
            <div className="fixed bottom-20 left-4 right-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 p-4 rounded-lg shadow-lg flex justify-between items-center z-50 toast-animate">
                <span>{message}</span>
                {hasUndo && <button onClick={onUndo} className="text-blue-400 dark:text-blue-600 font-bold ml-4">DESHACER</button>}
            </div>
        );
        
        // --- COMPONENTE DE ALARMA ---
        const AlarmModal = ({ isOpen, onClose, onSave, initialValue }) => {
            const [time, setTime] = React.useState(initialValue || '');

            React.useEffect(() => {
                if (isOpen) setTime(initialValue || '');
            }, [isOpen, initialValue]);

            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 110}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-xs w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white">Recordatorio</h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Av√≠same cuando sean las:
                        </p>
                        <input 
                            type="time" 
                            className="w-full p-2 text-2xl font-bold text-center border rounded-xl mb-6 dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none block"
                            value={time}
                            onChange={(e) => setTime(e.target.value)}
                        />
                        <div className="flex gap-3">
                             <Button variant="secondary" onClick={() => onSave('')} className="flex-1">Borrar</Button>
                             <Button onClick={() => onSave(time)} className="flex-1">Guardar</Button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AlarmBanner = ({ data, onClose }) => {
            if (!data) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in zoom-in duration-300">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-6 relative border-t-8 border-yellow-400">
                         <div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-yellow-400 p-4 rounded-full shadow-lg bell-ring">
                            <Icons.Bell size={32} className="text-white" />
                         </div>
                         <div className="mt-6 text-center">
                            <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-1">{data.time}</h2>
                            <p className="text-sm font-semibold text-yellow-600 dark:text-yellow-400 mb-4 uppercase tracking-wider">Recordatorio de Visita</p>
                            
                            <div className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 mb-6 border border-gray-100 dark:border-gray-700">
                                <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-1">{data.name}</h3>
                                <p className="text-gray-500 dark:text-gray-300 text-sm flex items-center justify-center gap-1">
                                    <Icons.MapPin size={14}/> {data.address}
                                </p>
                            </div>
                            
                            <Button onClick={onClose} className="w-full py-4 text-lg shadow-lg bg-yellow-400 hover:bg-yellow-500 text-white border-none">
                                ¬°Entendido!
                            </Button>
                         </div>
                    </div>
                </div>
            );
        };


        // --- COMPONENTE MODAL DE DEUDA ---
        const DebtModal = ({ isOpen, client, onClose, onSave }) => {
            const [amount, setAmount] = React.useState('');

            React.useEffect(() => {
                if (isOpen) setAmount('');
            }, [isOpen]);

            if (!isOpen || !client) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 110}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-xs w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white flex items-center gap-2">
                                <div className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-1.5 rounded-lg"><Icons.DollarSign size={18} /></div>
                                Registrar Deuda
                            </h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>
                        <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 mb-4">
                            <p className="font-bold text-gray-800 dark:text-white text-sm">{(client.name || '').toUpperCase()}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">{client.address}</p>
                        </div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">¬øCu√°nto debe?</label>
                        <div className="relative mb-4">
                            <span className="absolute left-3 top-2.5 text-gray-400 dark:text-gray-500 text-lg font-bold">$</span>
                            <input 
                                type="number" 
                                inputMode="decimal"
                                className="w-full p-3 pl-8 text-2xl font-bold text-center border rounded-xl dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-red-500 outline-none"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0"
                                autoFocus
                            />
                        </div>
                        <div className="flex gap-3">
                            <Button variant="secondary" onClick={onClose} className="flex-1">Cancelar</Button>
                            <Button variant="danger" onClick={() => onSave(client, amount)} className="flex-1 !bg-red-600 !text-white !hover:bg-red-700">
                                <Icons.DollarSign size={16}/> A√±adir Deuda
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE MODAL EDITAR DEUDA ---
        const EditDebtModal = ({ isOpen, debt, onClose, onSave }) => {
            const [amount, setAmount] = React.useState('');

            React.useEffect(() => {
                if (debt) setAmount(String(debt.amount || ''));
            }, [debt]);

            if (!isOpen || !debt) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 110}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-xs w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white flex items-center gap-2">
                                <div className="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 p-1.5 rounded-lg"><Icons.Edit size={18} /></div>
                                Editar Deuda
                            </h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>
                        <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 mb-4">
                            <p className="font-bold text-gray-800 dark:text-white text-sm">{(debt.clientName || '').toUpperCase()}</p>
                        </div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nuevo monto</label>
                        <div className="relative mb-4">
                            <span className="absolute left-3 top-2.5 text-gray-400 dark:text-gray-500 text-lg font-bold">$</span>
                            <input 
                                type="number" 
                                inputMode="decimal"
                                className="w-full p-3 pl-8 text-2xl font-bold text-center border rounded-xl dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                autoFocus
                            />
                        </div>
                        <div className="flex gap-3">
                            <Button variant="secondary" onClick={onClose} className="flex-1">Cancelar</Button>
                            <Button onClick={() => { onSave(debt, amount); onClose(); }} className="flex-1">
                                <Icons.Save size={16}/> Guardar
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE MODAL VER DEUDAS DE CLIENTE ---
        const ViewDebtModal = ({ isOpen, client, debts, onClose, onPaid, onEdit, onAddMore }) => {
            if (!isOpen || !client) return null;
            const clientDebts = debts.filter(d => d.clientId === client.id);
            const total = clientDebts.reduce((sum, d) => sum + (d.amount || 0), 0);

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 110}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-5">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white flex items-center gap-2">
                                <div className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-1.5 rounded-lg"><Icons.DollarSign size={18} /></div>
                                Deudas
                            </h3>
                            <div className="flex items-center gap-2">
                                {clientDebts.length === 1 && (
                                    <button 
                                        onClick={() => onPaid(clientDebts[0])}
                                        className="px-3 py-1.5 bg-green-500 text-white rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-green-600 transition-colors"
                                    >
                                        <Icons.CheckCircle size={14} /> Pagada
                                    </button>
                                )}
                                <button onClick={onClose} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                            </div>
                        </div>
                        <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 mb-3">
                            <p className="font-bold text-gray-800 dark:text-white text-sm">{(client.name || '').toUpperCase()}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">{client.address}</p>
                        </div>

                        {clientDebts.length === 0 ? (
                            <p className="text-center text-gray-400 dark:text-gray-500 py-4 text-sm">No hay deudas registradas</p>
                        ) : (
                            <div className="space-y-2 max-h-60 overflow-y-auto mb-3">
                                {clientDebts.map(debt => (
                                    <div key={debt.id} className="bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 rounded-lg p-3 flex items-center justify-between">
                                        <div>
                                            <p className="text-xl font-black text-red-600 dark:text-red-400">${debt.amount?.toLocaleString()}</p>
                                            {debt.createdAt && (
                                                <p className="text-[10px] text-gray-400 dark:text-gray-500">
                                                    {new Date(debt.createdAt.seconds ? debt.createdAt.seconds * 1000 : debt.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
                                                </p>
                                            )}
                                        </div>
                                        <div className="flex gap-1.5">
                                            <button 
                                                onClick={() => { onClose(); onEdit(debt); }}
                                                className="p-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                                                title="Editar"
                                            >
                                                <Icons.Edit size={15} />
                                            </button>
                                            {clientDebts.length > 1 && (
                                                <button 
                                                    onClick={() => onPaid(debt)}
                                                    className="p-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors"
                                                    title="Pag√≥"
                                                >
                                                    <Icons.CheckCircle size={15} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {clientDebts.length > 1 && (
                            <div className="bg-red-100 dark:bg-red-900/20 rounded-lg p-2 mb-3 text-center">
                                <span className="text-sm font-bold text-red-700 dark:text-red-400">Total: ${total.toLocaleString()}</span>
                            </div>
                        )}

                        <Button variant="danger" onClick={() => { onClose(); onAddMore(client); }} className="w-full text-sm !bg-red-600 !text-white">
                            <Icons.Plus size={15} /> Agregar otra deuda
                        </Button>
                    </div>
                </div>
            );
        };

        const ScheduleModal = ({ isOpen, client, onClose, onSave }) => {
            if (!isOpen || !client) return null;
            const [localDays, setLocalDays] = React.useState(['Lunes']); // Array de d√≠as
            const [localFreq, setLocalFreq] = React.useState('once');
            const [localDate, setLocalDate] = React.useState('');
            const [localNotes, setLocalNotes] = React.useState('');
            const [localProducts, setLocalProducts] = React.useState({});

            const ALL_DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

            React.useEffect(() => {
                if (client) {
                    setLocalNotes(client.notes || '');
                    setLocalProducts(client.products || { b20: '', b12: '', b6: '', soda: '', bombita: '', disp_elec_new: '', disp_elec_chg: '', disp_nat: '' });
                    // Si ya tiene d√≠as asignados, cargarlos
                    if (client.visitDays && client.visitDays.length > 0) {
                        setLocalDays(client.visitDays);
                    } else if (client.visitDay && client.visitDay !== 'Sin Asignar') {
                        setLocalDays([client.visitDay]);
                    }
                }
            }, [client]);
            
            const handleProductChange = (prodId, val) => {
                setLocalProducts(prev => ({
                    ...prev,
                    [prodId]: val
                }));
            };

            const toggleDay = (day) => {
                setLocalDays(prev => {
                    if (prev.includes(day)) {
                        // No permitir quitar el √∫ltimo d√≠a
                        if (prev.length === 1) return prev;
                        return prev.filter(d => d !== day);
                    } else {
                        return [...prev, day];
                    }
                });
            };

            const handleSubmit = () => {
                if (localFreq === 'once' && !localDate) {
                    alert('Por favor, selecciona una fecha de entrega.');
                    return;
                }
                if (localFreq !== 'once' && localDays.length === 0) {
                    alert('Por favor, selecciona al menos un d√≠a.');
                    return;
                }
                onSave(client, localDays, localFreq, localDate, localNotes, localProducts);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 100}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white">Agendar Visita</h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>
                        <p className="mb-4 text-sm text-gray-600 dark:text-gray-400">Programar a <strong>{client.name}</strong> para:</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1 dark:text-gray-300">Tipo de Pedido</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <label className={`border dark:border-gray-600 p-2 rounded cursor-pointer text-center text-sm ${localFreq === 'once' ? 'bg-orange-50 border-orange-500 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300' : 'dark:text-gray-300'}`}>
                                        <input type="radio" name="schFreq" value="once" checked={localFreq === 'once'} onChange={() => setLocalFreq('once')} className="hidden" />
                                        Una Vez
                                    </label>
                                    <label className={`border dark:border-gray-600 p-2 rounded cursor-pointer text-center text-sm ${localFreq === 'weekly' ? 'bg-blue-50 border-blue-500 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' : 'dark:text-gray-300'}`}>
                                        <input type="radio" name="schFreq" value="weekly" checked={localFreq === 'weekly'} onChange={() => setLocalFreq('weekly')} className="hidden" />
                                        Semanal
                                    </label>
                                </div>
                            </div>

                            {localFreq === 'once' ? (
                                <div>
                                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Fecha de Entrega</label>
                                    <input 
                                        type="date" 
                                        value={localDate} 
                                        onChange={(e) => setLocalDate(e.target.value)} 
                                        className="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                        min={new Date().toISOString().split('T')[0]}
                                    />
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Se agendar√° autom√°ticamente para el d√≠a correspondiente.</p>
                                </div>
                            ) : (
                                <div>
                                    <label className="block text-sm font-medium mb-2 dark:text-gray-300">D√≠as de Visita <span className="text-xs text-gray-400">(puede elegir varios)</span></label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {ALL_DAYS.map(day => (
                                            <button
                                                key={day}
                                                type="button"
                                                onClick={() => toggleDay(day)}
                                                className={`p-2 rounded-lg text-xs font-medium transition-all ${
                                                    localDays.includes(day)
                                                        ? 'bg-blue-500 text-white shadow-md'
                                                        : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
                                                }`}
                                            >
                                                {day.slice(0, 3)}
                                            </button>
                                        ))}
                                    </div>
                                    {localDays.length > 1 && (
                                        <p className="text-xs text-blue-600 dark:text-blue-400 mt-2">üìÖ {localDays.length} d√≠as seleccionados</p>
                                    )}
                                </div>
                            )}
                            
                            {/* SECCI√ìN PRODUCTOS EN MODAL */}
                            <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                <label className="block text-xs font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">üì¶ Productos</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {PRODUCTS.map(prod => (
                                        <div key={prod.id} className="flex items-center justify-between bg-white dark:bg-gray-800 p-1.5 rounded border border-gray-200 dark:border-gray-600">
                                            <span className="text-[10px] font-medium flex items-center gap-1 dark:text-gray-300">{prod.icon} {prod.short}</span>
                                            <input 
                                                type="number" 
                                                placeholder="0" 
                                                value={localProducts[prod.id] || ''}
                                                onChange={(e) => handleProductChange(prod.id, e.target.value)}
                                                className="w-8 p-0.5 text-center border rounded focus:ring-1 focus:ring-blue-500 outline-none text-xs dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1 dark:text-gray-300">Notas del Pedido</label>
                                <textarea 
                                    value={localNotes} 
                                    onChange={(e) => setLocalNotes(e.target.value)} 
                                    className="w-full p-3 border rounded-lg bg-gray-50 h-20 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Ej: Pedido especial..."
                                />
                            </div>
                            
                            <Button onClick={handleSubmit} className="w-full mt-2">Confirmar</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const PasteContactModal = ({ isOpen, onClose, onPaste }) => {
             if (!isOpen) return null;
             const [text, setText] = React.useState('');
             
             const handleConfirm = () => {
                 onPaste(text);
                 setText('');
             };

             return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 100}}>
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 dark:bg-gray-800">
                         <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white">Importar Texto</h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                             Peg√° el texto del pedido tal cual te lo env√≠an. Se detectar√°n autom√°ticamente: nombre, direcci√≥n, esquina, tel√©fono, link de Maps, productos y notas.
                        </p>
                        <textarea 
                            className="w-full border rounded p-3 h-40 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            placeholder={"Pedido de cliente:\nNombre: JACKELIN\nDirecci√≥n: LOS EUCALIPTUS M.20\nEsquina: BELEN Y LOS PINOS\nDetalle: LAGOMAR\nhttps://maps.app.goo.gl/...\nTel√©fono: 093900109\nBidon: 12Lts 1\nSoda: 0"}
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <Button onClick={handleConfirm} className="w-full mt-3">Procesar y Agregar</Button>
                    </div>
                </div>
             );
        };

        const OrderInput = ({ value, onChange }) => {
            const [localValue, setLocalValue] = React.useState(value);

            React.useEffect(() => {
                setLocalValue(value);
            }, [value]);

            const handleBlur = () => {
                if (localValue !== value) {
                    onChange(localValue);
                }
            };
            
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            }

            return (
                <input
                    type="number"
                    className="order-input"
                    value={localValue}
                    onChange={(e) => setLocalValue(e.target.value)}
                    onBlur={handleBlur}
                    onKeyDown={handleKeyDown}
                    inputMode="numeric"
                />
            );
        };

        // --- HOOK: DEBOUNCE PARA B√öSQUEDAS ---
        const useDebounce = (value, delay = 300) => {
            const [debouncedValue, setDebouncedValue] = React.useState(value);
            React.useEffect(() => {
                const handler = setTimeout(() => setDebouncedValue(value), delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        };

        // --- COMPONENTE MEMOIZADO: TARJETA DE CLIENTE ---
        const ClientCard = React.memo(({ client, trueIndex, isAdmin, onToggleStar, onDebtClick, onAddTransfer, onSetAlarm, onEdit, onDelete, onOpenMaps, onSendPhoto, onSendWhatsApp, onMarkDone, onChangePosition }) => {
            const prodSummary = React.useMemo(() => {
                if (!client.products) return '';
                return Object.keys(client.products)
                    .filter(k => parseInt(client.products[k] || 0) > 0)
                    .map(k => {
                        const p = PRODUCTS.find(prod => prod.id === k);
                        return `${client.products[k]}x ${p ? p.short : k}`;
                    }).join(', ');
            }, [client.products]);

            return (
                <Card className={`flex flex-row overflow-hidden ${(client.freq === 'once' || client.isStarred) ? 'border-l-4 border-l-orange-500 dark:border-l-orange-600 bg-orange-50 dark:bg-gray-800' : ''}`}>
                    {/* ORDER INPUT BADGE */}
                    <div className="w-10 bg-gray-50 dark:bg-gray-700/50 flex flex-col justify-center items-center border-r border-gray-100 dark:border-gray-700 p-0.5">
                         <OrderInput
                            value={trueIndex + 1}
                            onChange={(newPos) => onChangePosition(client.id, newPos)}
                         />
                    </div>

                    {/* CARD CONTENT */}
                    <div className="flex-1 p-3 flex flex-col gap-2">
                        {/* Botones de herramientas - arriba a la derecha */}
                        <div className="flex items-center justify-end gap-1">
                            <button onClick={() => onToggleStar(client)} className={`p-1.5 rounded-md transition-colors ${client.isStarred ? 'text-orange-500 bg-orange-50 dark:bg-orange-900/20' : 'text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}><Icons.Star size={15} fill={client.isStarred ? "currentColor" : "none"} /></button>
                            <button onClick={() => onDebtClick(client)} className={`p-1.5 rounded-md transition-colors ${client.hasDebt ? 'text-red-500 bg-red-50 dark:bg-red-900/20' : 'text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}><Icons.DollarSign size={15} /></button>
                            <button onClick={() => onAddTransfer(client)} className={`p-1.5 rounded-md transition-colors ${client.hasPendingTransfer ? 'text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20' : 'text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}><Icons.CreditCard size={15} /></button>
                            <div className="w-px h-4 bg-gray-200 dark:bg-gray-600 mx-0.5"></div>
                            <button onClick={() => onSetAlarm(client)} className={`p-1.5 rounded-md transition-colors ${client.alarm ? 'text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20' : 'text-gray-400 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}><Icons.Bell size={15} /></button>
                            {isAdmin && <button onClick={() => onEdit(client)} className="p-1.5 rounded-md text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"><Icons.Edit size={15} /></button>}
                            {isAdmin && <button onClick={() => onDelete(client.id)} className="p-1.5 rounded-md text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"><Icons.Trash2 size={15} /></button>}
                        </div>

                        {/* Nombre y direcci√≥n - ancho completo debajo */}
                        <div className="-mt-1">
                            <h3 className="font-bold text-lg leading-tight text-gray-900 dark:text-white">{(client.name || '').toUpperCase()}</h3>
                            <div onClick={() => onOpenMaps(client.lat, client.lng, client.mapsLink)} className="text-gray-500 dark:text-gray-400 text-sm flex items-center gap-1 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 mt-0.5 hover:underline">
                                <Icons.MapPin size={14} /> {client.address}
                            </div>
                        </div>

                        {/* Info Block */}
                        <div className="flex flex-wrap gap-2 items-center">
                            {prodSummary && <span className="text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200 px-2 py-1 rounded-full border border-blue-200 dark:border-blue-800">üì¶ {prodSummary}</span>}
                            <Badge type={client.freq} date={client.specificDate} />
                            {client.visitDays && client.visitDays.length > 1 && (
                                <span className="text-xs font-bold bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 px-2 py-1 rounded-full border border-purple-200 dark:border-purple-800">
                                    üìÖ {client.visitDays.map(d => d.slice(0,3)).join(', ')}
                                </span>
                            )}
                        </div>
                        {client.notes && (
                            <div className="text-sm bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 p-2 rounded border border-yellow-100 dark:border-yellow-900/30 flex gap-1 items-start">
                                <span className="shrink-0">üìù</span>
                                <span>{client.notes}</span>
                            </div>
                        )}

                        {/* Action Bar - Separated */}
                        <div className="flex gap-1.5 mt-2 pt-2 border-t border-gray-100 dark:border-gray-700 items-center">
                            {/* Tel√©fono */}
                            {client.phone ? (
                                <a href={`tel:${client.phone}`} className="flex items-center justify-center p-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 w-9 shrink-0"><Icons.Phone size={17} /></a>
                            ) : (
                                <span className="flex items-center justify-center p-2 bg-gray-50 dark:bg-gray-800 text-gray-300 dark:text-gray-600 rounded-lg cursor-not-allowed w-9 shrink-0"><Icons.Phone size={17} /></span>
                            )}

                            {/* C√°mara / Chat */}
                            {client.phone ? (
                                <button onClick={() => onSendPhoto(client.phone)} className="flex items-center justify-center p-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 w-9 shrink-0"><Icons.Camera size={17} /></button>
                            ) : (
                                <span className="flex items-center justify-center p-2 bg-gray-50 dark:bg-gray-800 text-gray-300 dark:text-gray-600 rounded-lg cursor-not-allowed w-9 shrink-0"><Icons.Camera size={17} /></span>
                            )}

                            {/* En Camino */}
                            {client.phone ? (
                                <button
                                    onClick={() => onSendWhatsApp(client.phone)}
                                    className="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-2 px-2 rounded-lg shadow-sm flex items-center justify-center gap-1 text-sm transition-colors whitespace-nowrap"
                                >
                                    <Icons.MessageCircle size={17} />
                                    <span>En camino</span>
                                </button>
                            ) : (
                                <span className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500 font-bold py-2 px-2 rounded-lg flex items-center justify-center gap-1 text-sm cursor-not-allowed whitespace-nowrap">
                                    <Icons.MessageCircle size={17} />
                                    <span>Sin tel.</span>
                                </span>
                            )}

                            {/* Listo */}
                            <button
                                onClick={() => onMarkDone(client)}
                                className="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-2 px-3 rounded-lg shadow-sm flex items-center justify-center gap-1 text-sm transition-colors whitespace-nowrap shrink-0"
                            >
                                <Icons.CheckCircle size={17} />
                                <span>Listo</span>
                            </button>
                        </div>
                    </div>
                </Card>
            );
        }, (prevProps, nextProps) => {
            // Comparador custom: solo re-renderizar si cambian datos relevantes
            if (prevProps.trueIndex !== nextProps.trueIndex || prevProps.isAdmin !== nextProps.isAdmin) return false;
            const pc = prevProps.client, nc = nextProps.client;
            return pc.id === nc.id && pc.name === nc.name && pc.address === nc.address &&
                   pc.phone === nc.phone && pc.freq === nc.freq && pc.isStarred === nc.isStarred &&
                   pc.hasDebt === nc.hasDebt && pc.hasPendingTransfer === nc.hasPendingTransfer &&
                   pc.alarm === nc.alarm && pc.notes === nc.notes && pc.specificDate === nc.specificDate &&
                   JSON.stringify(pc.products) === JSON.stringify(nc.products) &&
                   JSON.stringify(pc.visitDays) === JSON.stringify(nc.visitDays);
        });

        const ProductCounter = ({ clients }) => {
            const totals = clients.reduce((acc, client) => {
                if (!client.products) return acc;
                Object.keys(client.products).forEach(key => {
                    const qty = parseInt(client.products[key] || 0);
                    if (qty > 0) {
                        acc[key] = (acc[key] || 0) + qty;
                    }
                });
                return acc;
            }, {});

            const activeProducts = Object.keys(totals).filter(k => totals[k] > 0);
            
            if (clients.length === 0) return null;

            return (
                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-blue-100 dark:border-gray-700 mb-4 animate-in fade-in slide-in-from-top-4 duration-300">
                     <div className="flex justify-between items-center mb-3">
                        <h3 className="text-xs font-bold text-blue-800 dark:text-blue-300 uppercase tracking-wider flex items-center gap-2">
                            <Icons.Package size={14} /> Total Carga ({clients.length} Clientes)
                        </h3>
                     </div>
                    {activeProducts.length > 0 ? (
                        <div className="grid grid-cols-4 gap-2">
                            {activeProducts.map(key => {
                                const prod = PRODUCTS.find(p => p.id === key);
                                return (
                                    <div key={key} className="bg-blue-50 dark:bg-gray-700 rounded-lg p-2 flex flex-col items-center justify-center border border-blue-100 dark:border-gray-600">
                                        <span className="text-xl font-black text-blue-600 dark:text-blue-300">{totals[key]}</span>
                                        <span className="text-[10px] text-blue-400 dark:text-blue-200 font-medium uppercase">{prod ? prod.short : key}</span>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                         <p className="text-xs text-gray-400 italic">No hay productos asignados para esta lista.</p>
                    )}
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen flex items-center justify-center bg-blue-600 dark:bg-gray-900 p-6">
                <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full">
                    <div className="bg-blue-50 dark:bg-gray-700 p-6 rounded-full w-24 h-24 mx-auto mb-6 flex items-center justify-center text-blue-600 dark:text-blue-400">
                        <Icons.Truck />
                    </div>
                    <h1 className="text-3xl font-extrabold text-gray-900 dark:text-white mb-2">RutaWater</h1>
                    <p className="text-gray-500 dark:text-gray-400 mb-8 leading-relaxed">Gestiona tus clientes y rutas de reparto de forma inteligente.</p>
                    
                    <Button variant="google" onClick={onLogin} className="w-full shadow-sm py-4">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" alt="G" />
                        <span className="text-base">Continuar con Google</span>
                    </Button>
                    <p className="mt-6 text-xs text-gray-400">Tus datos se guardar√°n seguros en la nube.</p>
                </div>
            </div>
        );

        // --- COMPONENTE MODAL GRUPO FAMILIAR ---
        const GroupModal = ({ isOpen, onClose, user, groupData, onGroupUpdate }) => {
            const [activeTab, setActiveTab] = React.useState('info'); // 'info', 'create', 'join'
            const [joinCode, setJoinCode] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [members, setMembers] = React.useState([]);

            React.useEffect(() => {
                if (isOpen && groupData?.groupId) {
                    // Cargar miembros del grupo
                    db.collection('users')
                        .where('groupId', '==', groupData.groupId)
                        .get()
                        .then(snapshot => {
                            const membersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setMembers(membersList);
                        });
                }
            }, [isOpen, groupData?.groupId]);

            if (!isOpen) return null;

            const generateCode = () => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
                return code;
            };

            const handleCreateGroup = async () => {
                setLoading(true);
                setError('');
                try {
                    const code = generateCode();
                    const groupId = `group_${user.uid}_${Date.now()}`;
                    
                    // Crear documento del grupo
                    await db.collection('groups').doc(groupId).set({
                        code: code,
                        adminId: user.uid,
                        adminEmail: user.email,
                        adminName: user.displayName || user.email,
                        createdAt: new Date()
                    });
                    
                    // Actualizar usuario como admin del grupo
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        displayName: user.displayName || user.email,
                        groupId: groupId,
                        role: 'admin',
                        joinedAt: new Date()
                    }, { merge: true });
                    
                    // Migrar datos existentes al grupo (en batches de 450 para respetar l√≠mite de 500)
                    const allDocs = [];

                    const clientsSnap = await db.collection('clients').where('userId', '==', user.uid).get();
                    clientsSnap.docs.forEach(doc => allDocs.push(doc.ref));

                    const debtsSnap = await db.collection('debts').where('userId', '==', user.uid).get();
                    debtsSnap.docs.forEach(doc => allDocs.push(doc.ref));

                    const transfersSnap = await db.collection('transfers').where('userId', '==', user.uid).get();
                    transfersSnap.docs.forEach(doc => allDocs.push(doc.ref));

                    for (let i = 0; i < allDocs.length; i += 450) {
                        const batch = db.batch();
                        allDocs.slice(i, i + 450).forEach(ref => {
                            batch.update(ref, { groupId: groupId });
                        });
                        await batch.commit();
                    }
                    
                    onGroupUpdate({ groupId, role: 'admin', code });
                    setActiveTab('info');
                } catch(e) {
                    console.error(e);
                    setError('Error al crear el grupo');
                }
                setLoading(false);
            };

            const handleJoinGroup = async () => {
                if (joinCode.length !== 6) {
                    setError('El c√≥digo debe tener 6 caracteres');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    // Buscar grupo por c√≥digo
                    const groupSnap = await db.collection('groups').where('code', '==', joinCode.toUpperCase()).get();
                    
                    if (groupSnap.empty) {
                        setError('C√≥digo no v√°lido');
                        setLoading(false);
                        return;
                    }
                    
                    const groupDoc = groupSnap.docs[0];
                    const groupId = groupDoc.id;
                    
                    // Verificar que no est√© ya en un grupo
                    if (groupData?.groupId) {
                        setError('Ya perteneces a un grupo');
                        setLoading(false);
                        return;
                    }
                    
                    // Unirse al grupo como miembro
                    await db.collection('users').doc(user.uid).set({
                        email: user.email,
                        displayName: user.displayName || user.email,
                        groupId: groupId,
                        role: 'member',
                        joinedAt: new Date()
                    }, { merge: true });
                    
                    onGroupUpdate({ groupId, role: 'member' });
                    setActiveTab('info');
                    setJoinCode('');
                } catch(e) {
                    console.error(e);
                    setError('Error al unirse al grupo');
                }
                setLoading(false);
            };

            const handleLeaveGroup = async () => {
                setLoading(true);
                try {
                    await db.collection('users').doc(user.uid).update({
                        groupId: null,
                        role: null
                    });
                    onGroupUpdate(null);
                    onClose();
                } catch(e) {
                    console.error(e);
                    setError('Error al salir del grupo');
                }
                setLoading(false);
            };

            const handleRemoveMember = async (memberId) => {
                if (memberId === user.uid) return;
                setLoading(true);
                try {
                    await db.collection('users').doc(memberId).update({
                        groupId: null,
                        role: null
                    });
                    setMembers(prev => prev.filter(m => m.id !== memberId));
                } catch(e) {
                    console.error(e);
                }
                setLoading(false);
            };

            const handleDissolveGroup = async () => {
                if (!window.confirm('¬øEst√°s seguro de disolver el grupo? Todos los miembros ser√°n removidos y los datos volver√°n a ser solo tuyos.')) return;
                setLoading(true);
                try {
                    const groupId = groupData.groupId;

                    // Recopilar todos los documentos a actualizar
                    const updates = []; // { ref, data }

                    const membersSnap = await db.collection('users').where('groupId', '==', groupId).get();
                    membersSnap.docs.forEach(doc => updates.push({ ref: doc.ref, data: { groupId: null, role: null } }));

                    const clientsSnap = await db.collection('clients').where('groupId', '==', groupId).get();
                    clientsSnap.docs.forEach(doc => updates.push({ ref: doc.ref, data: { groupId: null } }));

                    const debtsSnap = await db.collection('debts').where('groupId', '==', groupId).get();
                    debtsSnap.docs.forEach(doc => updates.push({ ref: doc.ref, data: { groupId: null } }));

                    const transfersSnap = await db.collection('transfers').where('groupId', '==', groupId).get();
                    transfersSnap.docs.forEach(doc => updates.push({ ref: doc.ref, data: { groupId: null } }));

                    // Ejecutar en batches de 450 para respetar l√≠mite de 500
                    for (let i = 0; i < updates.length; i += 450) {
                        const batch = db.batch();
                        updates.slice(i, i + 450).forEach(({ ref, data }) => batch.update(ref, data));
                        await batch.commit();
                    }

                    // Eliminar el grupo
                    await db.collection('groups').doc(groupId).delete();

                    onGroupUpdate(null);
                    onClose();
                } catch(e) {
                    console.error(e);
                    setError('Error al disolver el grupo');
                }
                setLoading(false);
            };

            const isAdmin = groupData?.role === 'admin';

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" style={{zIndex: 120}}>
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-5">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold dark:text-white flex items-center gap-2">
                                <div className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 p-1.5 rounded-lg"><Icons.Users size={18} /></div>
                                Grupo Familiar
                            </h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-gray-400 dark:text-gray-500" /></button>
                        </div>

                        {error && (
                            <div className="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm p-3 rounded-lg mb-4">
                                {error}
                            </div>
                        )}

                        {/* SIN GRUPO */}
                        {!groupData?.groupId ? (
                            <div>
                                {activeTab === 'info' && (
                                    <div className="space-y-3">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                            Crea un grupo para compartir tu cartera de clientes con tu equipo, o √∫nete a uno existente.
                                        </p>
                                        <Button onClick={() => setActiveTab('create')} className="w-full">
                                            <Icons.Plus size={16} /> Crear Grupo
                                        </Button>
                                        <Button variant="secondary" onClick={() => setActiveTab('join')} className="w-full">
                                            Tengo un c√≥digo
                                        </Button>
                                    </div>
                                )}

                                {activeTab === 'create' && (
                                    <div className="space-y-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Al crear un grupo ser√°s el <strong>administrador</strong>. Podr√°s invitar a otros con un c√≥digo y ellos tendr√°n permisos limitados.
                                        </p>
                                        <div className="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg text-xs text-yellow-700 dark:text-yellow-300">
                                            <strong>Permisos de miembros:</strong> Ver clientes, marcar completados, agregar deudas/transferencias. NO pueden eliminar ni editar clientes.
                                        </div>
                                        <div className="flex gap-2">
                                            <Button variant="secondary" onClick={() => setActiveTab('info')} className="flex-1" disabled={loading}>Cancelar</Button>
                                            <Button onClick={handleCreateGroup} className="flex-1 !bg-purple-600" disabled={loading}>
                                                {loading ? 'Creando...' : 'Crear Grupo'}
                                            </Button>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'join' && (
                                    <div className="space-y-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400">
                                            Ingresa el c√≥digo de 6 caracteres que te comparti√≥ el administrador del grupo.
                                        </p>
                                        <input 
                                            type="text" 
                                            maxLength={6}
                                            value={joinCode}
                                            onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                                            placeholder="C√ìDIGO"
                                            className="w-full p-4 text-2xl font-bold text-center tracking-[0.5em] border-2 rounded-xl dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none uppercase"
                                        />
                                        <div className="flex gap-2">
                                            <Button variant="secondary" onClick={() => { setActiveTab('info'); setJoinCode(''); setError(''); }} className="flex-1" disabled={loading}>Cancelar</Button>
                                            <Button onClick={handleJoinGroup} className="flex-1 !bg-purple-600" disabled={loading || joinCode.length !== 6}>
                                                {loading ? 'Uniendo...' : 'Unirme'}
                                            </Button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* CON GRUPO */
                            <div className="space-y-4">
                                {/* Info del grupo */}
                                <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-xs text-purple-600 dark:text-purple-400 font-bold uppercase">
                                                {isAdmin ? 'üëë Administrador' : 'üë§ Miembro'}
                                            </p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{user.email}</p>
                                        </div>
                                        {isAdmin && groupData.code && (
                                            <div className="text-right">
                                                <p className="text-[10px] text-gray-500 dark:text-gray-400 uppercase">C√≥digo</p>
                                                <p className="text-lg font-black text-purple-600 dark:text-purple-400 tracking-wider">{groupData.code}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Lista de miembros (solo admin) */}
                                {isAdmin && members.length > 0 && (
                                    <div>
                                        <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Miembros ({members.length})</p>
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {members.map(member => (
                                                <div key={member.id} className="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-sm">{member.role === 'admin' ? 'üëë' : 'üë§'}</span>
                                                        <div>
                                                            <p className="text-sm font-medium dark:text-white">{member.displayName || member.email}</p>
                                                            <p className="text-[10px] text-gray-400">{member.role === 'admin' ? 'Admin' : 'Miembro'}</p>
                                                        </div>
                                                    </div>
                                                    {member.id !== user.uid && member.role !== 'admin' && (
                                                        <button 
                                                            onClick={() => handleRemoveMember(member.id)}
                                                            className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded"
                                                            disabled={loading}
                                                        >
                                                            <Icons.X size={14} />
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Permisos info para miembros */}
                                {!isAdmin && (
                                    <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-xs text-gray-600 dark:text-gray-400">
                                        <strong>Tus permisos:</strong> Ver clientes, marcar completados, agregar deudas y transferencias.
                                    </div>
                                )}

                                {/* Bot√≥n salir (miembros) */}
                                {!isAdmin && (
                                    <Button variant="danger" onClick={handleLeaveGroup} className="w-full" disabled={loading}>
                                        {loading ? 'Saliendo...' : 'Salir del Grupo'}
                                    </Button>
                                )}

                                {/* Bot√≥n disolver grupo (admin) */}
                                {isAdmin && (
                                    <Button variant="danger" onClick={handleDissolveGroup} className="w-full mt-3" disabled={loading}>
                                        {loading ? 'Disolviendo...' : 'Disolver Grupo'}
                                    </Button>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = React.useState('list');
            const [clients, setClients] = React.useState([]);
            const [editingId, setEditingId] = React.useState(null);
            const [isCloudActive, setIsCloudActive] = React.useState(false);
            const [user, setUser] = React.useState(null);
            const [loadingAuth, setLoadingAuth] = React.useState(true);
            const [selectedDay, setSelectedDay] = React.useState('Lunes');
            const [searchTerm, setSearchTerm] = React.useState('');
            const [listSearchTerm, setListSearchTerm] = React.useState('');
            const [activeFilters, setActiveFilters] = React.useState([]); // ['once_starred', 'b20', 'b12', etc.]
            const [showFilterMenu, setShowFilterMenu] = React.useState(false);
            const [scheduleClient, setScheduleClient] = React.useState(null);
            const [confirmModal, setConfirmModal] = React.useState({ isOpen: false, title: '', message: '', action: null, isDanger: true });
            const [formData, setFormData] = React.useState({
                name: '', phone: '', address: '', lat: '', lng: '', freq: 'weekly', visitDay: 'Lunes', visitDays: ['Lunes'], notes: '', locationInput: '', specificDate: '',
                products: { b20: '', b12: '', b6: '', soda: '', bombita: '', disp_elec_new: '', disp_elec_chg: '', disp_nat: '' }
            });
            const [dailyLoad, setDailyLoad] = React.useState({ 
                b20: '', b12: '', b6: '', soda: '', 
                b20_extra: '', b12_extra: '', b6_extra: '', soda_extra: '', pedidos_note: ''
            });
            const [toast, setToast] = React.useState(null);
            const [showPasteModal, setShowPasteModal] = React.useState(false);
            
            // --- ESTADO ALARMA ---
            const [alarmModal, setAlarmModal] = React.useState({ isOpen: false, clientId: null, currentVal: '' });
            const [activeAlert, setActiveAlert] = React.useState(null);

            // --- ESTADO MEN√ö SECCIONES ---
            const [activeSection, setActiveSection] = React.useState('cartera'); // 'cartera', 'deudas', 'transferencias'
            const [showSectionMenu, setShowSectionMenu] = React.useState(false);

            // --- ESTADO DEUDAS ---
            const [debts, setDebts] = React.useState([]);
            const [debtModal, setDebtModal] = React.useState({ isOpen: false, client: null });
            const [editDebtModal, setEditDebtModal] = React.useState({ isOpen: false, debt: null });
            const [viewDebtModal, setViewDebtModal] = React.useState({ isOpen: false, client: null });

            // --- ESTADO TRANSFERENCIAS ---
            const [transfers, setTransfers] = React.useState([]);

            // --- ESTADO B√öSQUEDA DEUDAS/TRANSFERENCIAS ---
            const [debtSearchTerm, setDebtSearchTerm] = React.useState('');
            const [transferSearchTerm, setTransferSearchTerm] = React.useState('');

            // --- ESTADO GRUPO FAMILIAR ---
            const [groupData, setGroupData] = React.useState(null); // { groupId, role, code }
            const [showGroupModal, setShowGroupModal] = React.useState(false);

            // --- HELPERS DE PERMISOS ---
            const isAdmin = !groupData || groupData.role === 'admin';
            const getDataScope = () => {
                if (groupData?.groupId) {
                    return { groupId: groupData.groupId };
                }
                return { userId: user?.uid };
            };

            // --- B√öSQUEDAS DEBOUNCED (evitar filtrado en cada tecla) ---
            const debouncedListSearch = useDebounce(listSearchTerm, 300);
            const debouncedSearch = useDebounce(searchTerm, 300);
            const debouncedDebtSearch = useDebounce(debtSearchTerm, 300);
            const debouncedTransferSearch = useDebounce(transferSearchTerm, 300);

            // --- HANDLERS MEMOIZADOS PARA ClientCard ---
            const handleDebtClick = React.useCallback((client) => {
                if (client.hasDebt) {
                    setViewDebtModal({ isOpen: true, client });
                } else {
                    setDebtModal({ isOpen: true, client });
                }
            }, []);

            const handleSetAlarmForClient = React.useCallback((client) => {
                setAlarmModal({ isOpen: true, clientId: client.id, currentVal: client.alarm || '' });
            }, []);

            const toastTimeout = React.useRef(null);

            // --- DATE HELPER ROBUSTO (NORMALIZACI√ìN Y ZONA HORARIA) ---
            const parseDate = (val) => {
                if (!val) return null;
                if (val.seconds !== undefined) return new Date(val.seconds * 1000);
                return new Date(val);
            };

            const normalizeText = (text) => {
                if(!text) return "";
                return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            const getDayIndex = (dayName) => {
                if (!dayName) return -1;
                const normalized = normalizeText(dayName);
                const map = {
                    'domingo': 0, 'lunes': 1, 'martes': 2, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sabado': 6
                };
                return map[normalized] !== undefined ? map[normalized] : -1;
            };

            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            };

            const getNextVisitDate = (client, forDay = null) => {
                if (client.specificDate) return new Date(client.specificDate + 'T12:00:00');
                if (client.freq === 'once') return null; 

                const today = new Date();
                today.setHours(0,0,0,0);
                
                // Si se especifica un d√≠a, usar ese; sino usar el visitDay del cliente
                const dayToUse = forDay || client.visitDay;
                const targetDayIndex = getDayIndex(dayToUse);
                if (targetDayIndex === -1) return null;

                const currentDayIndex = today.getDay(); 
                let diff = targetDayIndex - currentDayIndex;
                if (diff < 0) diff += 7;
                
                const nextDate = new Date(today);
                nextDate.setDate(today.getDate() + diff);
                
                // --- L√ìGICA DE PERIODICIDAD ROBUSTA ---
                const lastVisited = parseDate(client.lastVisited);
                
                let intervalWeeks = 1;
                if (client.freq === 'biweekly') intervalWeeks = 2;
                if (client.freq === 'triweekly') intervalWeeks = 3;
                if (client.freq === 'monthly') intervalWeeks = 4;

                if (lastVisited) {
                     const lastVisitedDay = new Date(lastVisited);
                     lastVisitedDay.setHours(0,0,0,0);

                     // SI SE VISIT√ì HOY O EN EL FUTURO, saltar.
                     if (lastVisitedDay.getTime() >= today.getTime()) {
                         nextDate.setDate(nextDate.getDate() + (intervalWeeks * 7));
                     } else {
                         // L√≥gica de "catch up" para semanas intermedias
                         if (intervalWeeks > 1) {
                             const daysSince = (nextDate.getTime() - lastVisitedDay.getTime()) / (1000 * 3600 * 24);
                             // Si estamos en la semana "off", sumar intervalo
                             if (daysSince < (intervalWeeks * 7) - 3) {
                                  // Ajuste simple: Si la visita fue reciente, proyectar futuro
                                  if (daysSince < 7) {
                                      nextDate.setDate(nextDate.getDate() + (intervalWeeks * 7) - 7);
                                  }
                             }
                         }
                     }
                }
                
                return nextDate; 
            };

            const formatDate = (date) => {
                if (!date) return 'Sin fecha';
                const today = new Date();
                today.setHours(0,0,0,0);
                const d = new Date(date);
                d.setHours(0,0,0,0);
                if (d.getTime() === today.getTime()) return 'Para Hoy';
                const diffTime = d - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) return 'Ma√±ana';
                if (diffDays === 7) return 'Pr√≥xima Semana';
                return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            };

            // --- USE EFFECTS ---

            // Effect 1: Auth listener (solo se ejecuta una vez)
            React.useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (u) => {
                    setUser(u);
                    setLoadingAuth(false);

                    if (u) {
                        // Cargar datos del usuario para ver si pertenece a un grupo
                        const userDoc = await db.collection('users').doc(u.uid).get();
                        const userData = userDoc.exists ? userDoc.data() : null;

                        if (userData?.groupId) {
                            // Usuario en grupo - cargar datos del grupo
                            const groupDoc = await db.collection('groups').doc(userData.groupId).get();
                            const groupInfo = groupDoc.exists ? groupDoc.data() : {};
                            setGroupData({
                                groupId: userData.groupId,
                                role: userData.role,
                                code: groupInfo.code
                            });
                        } else {
                            // Usuario individual
                            setGroupData(null);
                        }
                    } else {
                        setClients([]);
                        setDebts([]);
                        setTransfers([]);
                        setGroupData(null);
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // Effect 2: Data listeners (se reconfigura cuando cambia user o groupData)
            React.useEffect(() => {
                if (!user) return;

                const queryField = groupData?.groupId ? 'groupId' : 'userId';
                const queryValue = groupData?.groupId || user.uid;

                // --- LISTENER CLIENTES ---
                const unsubClients = db.collection('clients')
                    .where(queryField, '==', queryValue)
                    .onSnapshot((snapshot) => {
                        const loadedClients = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        loadedClients.sort((a, b) => (a.listOrder || 0) - (b.listOrder || 0));
                        setClients(loadedClients);
                        setIsCloudActive(true);
                    }, (error) => {
                        console.error("Error DB:", error);
                        setIsCloudActive(false);
                    });

                // --- LISTENER DEUDAS ---
                const unsubDebts = db.collection('debts')
                    .where(queryField, '==', queryValue)
                    .onSnapshot((snapshot) => {
                        const loadedDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loadedDebts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setDebts(loadedDebts);
                    }, (error) => {
                        console.error("Error debts listener:", error);
                    });

                // --- LISTENER TRANSFERENCIAS ---
                const unsubTransfers = db.collection('transfers')
                    .where(queryField, '==', queryValue)
                    .onSnapshot((snapshot) => {
                        const loadedTransfers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loadedTransfers.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setTransfers(loadedTransfers);
                    }, (error) => {
                        console.error("Error transfers listener:", error);
                    });

                return () => {
                    unsubClients();
                    unsubDebts();
                    unsubTransfers();
                };
            }, [user, groupData]);
            
            // --- EFFECT PARA ALARMAS (RESTAURADO Y MEJORADO) ---
            React.useEffect(() => {
                const interval = setInterval(() => {
                    if (activeAlert) return; 
                    
                    const now = new Date();
                    // Asegurar formato HH:MM (24h) para coincidir con el input type="time"
                    const currentTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false }).slice(0, 5);
                    
                    // Obtener el nombre del d√≠a actual
                    const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                    const todayDayName = dayNames[now.getDay()];
                    
                    const match = clients.find(c => {
                        // 1. Coincide la hora?
                        if (c.alarm !== currentTime) return false;
                        
                        // 2. El cliente tiene visita programada para hoy?
                        const clientDays = c.visitDays || (c.visitDay ? [c.visitDay] : []);
                        if (!clientDays.includes(todayDayName)) return false;
                        
                        // 3. Coincide la fecha programada para este d√≠a?
                        const scheduledDate = getNextVisitDate(c, todayDayName);
                        if (!scheduledDate) return false;
                        
                        // Comparar solo d√≠a/mes/a√±o
                        return scheduledDate.toDateString() === now.toDateString();
                    });
                    
                    if (match) {
                        setActiveAlert({ 
                            name: match.name, 
                            address: match.address, 
                            time: currentTime,
                            id: match.id 
                        });
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    }
                }, 5000); // Chequear cada 5s para mayor precisi√≥n
                return () => clearInterval(interval);
            }, [clients, activeAlert]);

            React.useEffect(() => {
                if (!user || selectedDay === 'Todos' || !selectedDay) return;
                const docId = `${user.uid}_${selectedDay}`;
                db.collection('daily_loads').doc(docId).get().then(doc => {
                    if (doc.exists) setDailyLoad(doc.data());
                    else setDailyLoad({ b20: '', b12: '', b6: '', soda: '', b20_extra: '', b12_extra: '', b6_extra: '', soda_extra: '', pedidos_note: '' });
                });
            }, [user, selectedDay]);

            // --- TOAST LOGIC ---
            const showUndoToast = (message, undoAction) => {
                if (toastTimeout.current) clearTimeout(toastTimeout.current);
                setToast({ message, undoAction });
                toastTimeout.current = setTimeout(() => {
                    setToast(null);
                }, 3000);
            };

            const handleUndo = () => {
                if (toast && toast.undoAction) {
                    toast.undoAction();
                    setToast(null);
                    if (toastTimeout.current) clearTimeout(toastTimeout.current);
                }
            };
            
            // --- ALARMAS HANDLERS ---
            const handleSaveAlarm = async (time) => {
                if (alarmModal.clientId) {
                    await db.collection('clients').doc(alarmModal.clientId).update({ alarm: time });
                }
                setAlarmModal({ isOpen: false, clientId: null, currentVal: '' });
            };
            
            // --- DEUDAS HANDLERS ---
            const handleAddDebt = async (client, amount) => {
                if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) return;
                try {
                    await db.collection('debts').add({
                        ...getDataScope(),
                        userId: user.uid,
                        clientId: client.id,
                        clientName: client.name,
                        clientAddress: client.address,
                        clientLat: client.lat || null,
                        clientLng: client.lng || null,
                        clientMapsLink: client.mapsLink || null,
                        amount: parseFloat(amount),
                        createdAt: new Date(),
                        paid: false
                    });
                    // Marcar el cliente con deuda activa
                    await db.collection('clients').doc(client.id).update({ hasDebt: true });
                    setDebtModal({ isOpen: false, client: null });
                } catch(e) { console.error("Error creando deuda:", e); }
            };

            const handleDebtPaid = async (debt) => {
                try {
                    await db.collection('debts').doc(debt.id).delete();
                    // Consultar Firestore directamente para verificar deudas restantes
                    const remainingSnap = await db.collection('debts')
                        .where('clientId', '==', debt.clientId)
                        .get();
                    if (remainingSnap.empty) {
                        const clientRef = db.collection('clients').doc(debt.clientId);
                        const clientDoc = await clientRef.get();
                        if (clientDoc.exists) {
                            await clientRef.update({ hasDebt: false });
                        }
                    }
                } catch(e) { console.error("Error eliminando deuda:", e); }
            };

            const handleEditDebt = async (debt, newAmount) => {
                if (!newAmount || isNaN(parseFloat(newAmount)) || parseFloat(newAmount) <= 0) return;
                try {
                    await db.collection('debts').doc(debt.id).update({ amount: parseFloat(newAmount) });
                } catch(e) { console.error("Error editando deuda:", e); }
            };

            // --- TRANSFERENCIAS HANDLERS ---
            const handleAddTransfer = async (client) => {
                try {
                    // Verificar si ya tiene transferencia pendiente
                    const existing = transfers.find(t => t.clientId === client.id);
                    if (existing) {
                        showUndoToast("Ya tiene transferencia pendiente", null);
                        return;
                    }
                    
                    await db.collection('transfers').add({
                        ...getDataScope(),
                        userId: user.uid,
                        clientId: client.id,
                        clientName: client.name,
                        clientAddress: client.address,
                        clientLat: client.lat || null,
                        clientLng: client.lng || null,
                        clientMapsLink: client.mapsLink || null,
                        createdAt: new Date(),
                        reviewed: false
                    });
                    await db.collection('clients').doc(client.id).update({ hasPendingTransfer: true });
                } catch(e) { console.error("Error creando transferencia:", e); }
            };

            const handleTransferReviewed = async (transfer) => {
                try {
                    await db.collection('transfers').doc(transfer.id).delete();
                    // Consultar Firestore directamente para verificar transferencias restantes
                    const remainingSnap = await db.collection('transfers')
                        .where('clientId', '==', transfer.clientId)
                        .get();
                    if (remainingSnap.empty) {
                        const clientRef = db.collection('clients').doc(transfer.clientId);
                        const clientDoc = await clientRef.get();
                        if (clientDoc.exists) {
                            await clientRef.update({ hasPendingTransfer: false });
                        }
                    }
                } catch(e) { console.error("Error eliminando transferencia:", e); }
            };
            
            const handleToggleStar = async (client) => {
                await db.collection('clients').doc(client.id).update({ isStarred: !client.isStarred });
            };

            const handleDismissAlert = async () => {
                if (activeAlert && activeAlert.id) {
                     await db.collection('clients').doc(activeAlert.id).update({ alarm: '' });
                }
                setActiveAlert(null);
            };


            const handleMarkAsDoneInList = async (client) => {
                try {
                    if (client.freq === 'once') {
                        // Guardar solo los campos que cambiaron para el undo
                        const prevFields = {
                            isCompleted: client.isCompleted || false,
                            completedAt: client.completedAt || null,
                            updatedAt: client.updatedAt || null,
                            alarm: client.alarm || '',
                            isStarred: client.isStarred || false
                        };
                        const undoAction = async () => {
                            try {
                                await db.collection('clients').doc(client.id).update(prevFields);
                            } catch(e) { console.error("Undo error", e); }
                        };

                         await db.collection('clients').doc(client.id).update({
                            isCompleted: true,
                            completedAt: new Date(),
                            updatedAt: new Date(),
                            alarm: '',
                            isStarred: false
                        });
                        showUndoToast("Pedido completado", undoAction);
                    } else {
                        // Guardar solo los campos que cambiaron para el undo
                        const prevFields = {
                            lastVisited: client.lastVisited || null,
                            alarm: client.alarm || '',
                            isStarred: client.isStarred || false
                        };
                        if (client.specificDate) {
                            prevFields.specificDate = client.specificDate;
                        }

                        // L√≥gica corregida para peri√≥dicos
                        const updates = {
                            lastVisited: new Date(),
                            alarm: ''
                        };

                        // Si tiene fecha espec√≠fica (ancla), la movemos hacia adelante
                        if (client.specificDate) {
                            let interval = 1;
                            if (client.freq === 'biweekly') interval = 2;
                            if (client.freq === 'triweekly') interval = 3;
                            if (client.freq === 'monthly') interval = 4;

                            const currentSpecificDate = new Date(client.specificDate + 'T12:00:00');
                            const nextSpecificDate = new Date(currentSpecificDate);
                            nextSpecificDate.setDate(nextSpecificDate.getDate() + (interval * 7));

                            const today = new Date();
                            today.setHours(0,0,0,0);

                            while (nextSpecificDate < today) {
                                nextSpecificDate.setDate(nextSpecificDate.getDate() + (interval * 7));
                            }

                            updates.specificDate = nextSpecificDate.toISOString().split('T')[0];
                        }

                        // Si era un "Starred" temporal, quitamos la estrella al completar
                        if (client.isStarred) {
                            updates.isStarred = false;
                        }

                        await db.collection('clients').doc(client.id).update(updates);

                        const undoAction = async () => {
                            try {
                                await db.collection('clients').doc(client.id).update(prevFields);
                            } catch(e) { console.error("Undo error", e); }
                        };
                        showUndoToast("Pedido completado", undoAction);
                    }
                } catch(e) { console.error(e); }
            };
            
            const handleRestoreCompleted = async (client) => {
                try {
                    await db.collection('clients').doc(client.id).update({
                        isCompleted: false,
                        completedAt: null,
                        updatedAt: new Date()
                    });
                } catch(e) { console.error(e); }
            };
            
            const handleClearCompleted = (day) => {
                const completedForDay = clients.filter(c => 
                    c.isCompleted && 
                    c.freq === 'once' && 
                    c.visitDay === day
                );
                if (completedForDay.length === 0) return;
                
                setConfirmModal({
                    isOpen: true,
                    title: '¬øEliminar completados?',
                    message: `Se eliminar√°n ${completedForDay.length} pedido(s) completado(s) de ${day}.`,
                    confirmText: "Eliminar",
                    isDanger: true,
                    action: async () => {
                        try {
                            // Recopilar todas las operaciones de delete
                            const allDeletes = [];
                            completedForDay.forEach(c => {
                                allDeletes.push(db.collection('clients').doc(c.id));
                                debts.filter(d => d.clientId === c.id).forEach(d => {
                                    allDeletes.push(db.collection('debts').doc(d.id));
                                });
                                transfers.filter(t => t.clientId === c.id).forEach(t => {
                                    allDeletes.push(db.collection('transfers').doc(t.id));
                                });
                            });
                            // Ejecutar en batches de 450 para respetar l√≠mite de 500
                            for (let i = 0; i < allDeletes.length; i += 450) {
                                const batch = db.batch();
                                allDeletes.slice(i, i + 450).forEach(ref => batch.delete(ref));
                                await batch.commit();
                            }
                        } catch(e) { console.error(e); }
                        setConfirmModal(prev => ({...prev, isOpen: false}));
                    }
                });
            };

            
            const getVisibleClients = React.useCallback((dayToFilter) => {
                 const filtered = clients
                    .filter(c => c.freq !== 'on_demand')
                    .filter(c => !c.isCompleted)
                    // Excluir pedidos "once" sin fecha asignada (dato incompleto)
                    .filter(c => !(c.freq === 'once' && !c.specificDate))
                    .filter(c => {
                        if (dayToFilter === '') return true;
                        // Soportar tanto visitDays (array) como visitDay (string legacy)
                        if (c.visitDays && c.visitDays.length > 0) {
                            return c.visitDays.includes(dayToFilter);
                        }
                        return c.visitDay === dayToFilter;
                    });
                 
                 // Ordenar: priorizar listOrders del d√≠a, luego listOrder normalizado
                 return filtered.sort((a, b) => {
                    // Obtener orden espec√≠fico del d√≠a
                    const hasOrderA = a.listOrders && typeof a.listOrders[dayToFilter] === 'number';
                    const hasOrderB = b.listOrders && typeof b.listOrders[dayToFilter] === 'number';
                    
                    let orderA, orderB;
                    
                    if (hasOrderA) {
                        orderA = a.listOrders[dayToFilter];
                    } else {
                        // Si no tiene listOrders del d√≠a, usar listOrder pero normalizado
                        // Los timestamps son muy grandes, as√≠ que los ponemos al final
                        orderA = a.listOrder > 1000000 ? 999999 + (a.listOrder / 1e15) : (a.listOrder || 999999);
                    }
                    
                    if (hasOrderB) {
                        orderB = b.listOrders[dayToFilter];
                    } else {
                        orderB = b.listOrder > 1000000 ? 999999 + (b.listOrder / 1e15) : (b.listOrder || 999999);
                    }
                    
                    return orderA - orderB;
                 });
            }, [clients]);
            
            const getCompletedClients = React.useCallback((dayToFilter) => {
                 return clients
                    .filter(c => c.isCompleted && c.freq === 'once')
                    .filter(c => {
                        if (dayToFilter === '') return true;
                        if (c.visitDays && c.visitDays.length > 0) {
                            return c.visitDays.includes(dayToFilter);
                        }
                        return c.visitDay === dayToFilter;
                    })
                    .sort((a, b) => {
                        const dateA = a.completedAt?.seconds || 0;
                        const dateB = b.completedAt?.seconds || 0;
                        return dateB - dateA;
                    });
            }, [clients]);

            const groupedClients = React.useMemo(() => {
                if (view !== 'list') return {};
                
                const dayToFilter = selectedDay;
                
                const groups = {};
                let visible = getVisibleClients(dayToFilter);
                
                // Aplicar filtro de b√∫squeda (usa valor debounced)
                if (debouncedListSearch.trim()) {
                    const term = normalizeText(debouncedListSearch);
                    visible = visible.filter(c =>
                        normalizeText(c.name || '').includes(term) ||
                        normalizeText(c.address || '').includes(term)
                    );
                }
                
                // Aplicar filtros activos
                if (activeFilters.length > 0) {
                    visible = visible.filter(c => {
                        return activeFilters.every(filter => {
                            if (filter === 'once_starred') {
                                return c.freq === 'once' || c.isStarred;
                            }
                            if (filter === 'has_debt') {
                                return c.hasDebt === true;
                            }
                            // Es un filtro de producto (b20, b12, b6, soda, etc.)
                            return c.products && parseInt(c.products[filter] || 0) > 0;
                        });
                    });
                }
                
                visible.forEach(client => {
                        // Pasar el d√≠a actual para calcular la fecha correcta
                        const date = getNextVisitDate(client, dayToFilter);
                        let key = 0;
                        let label = "General";
                        if (date) {
                             date.setHours(0,0,0,0);
                             key = date.getTime();
                             label = formatDate(date);
                        } else {
                            if(client.visitDay && client.visitDay !== 'Sin Asignar') {
                                label = client.visitDay;
                                key = 0; 
                            }
                        }
                        
                        if (!groups[key]) groups[key] = { date: date, label: label, items: [] };
                        groups[key].items.push(client);
                    });
                
                const sortedKeys = Object.keys(groups).sort((a, b) => a - b);
                const sortedGroups = {};
                sortedKeys.forEach(key => sortedGroups[key] = groups[key]);
                return sortedGroups;
            }, [clients, selectedDay, view, getVisibleClients, debouncedListSearch, activeFilters]);

            // Calculate Counter Totals based on FIRST group (Nearest Date)
            const activeClientsForCounter = React.useMemo(() => {
                if (!groupedClients || Object.keys(groupedClients).length === 0) return [];
                const sortedKeys = Object.keys(groupedClients).sort((a, b) => parseFloat(a) - parseFloat(b));
                // Return items from the first key (earliest date)
                return groupedClients[sortedKeys[0]].items;
            }, [groupedClients]);

            // --- MAPA DE √çNDICES PRE-COMPUTADO (O(n) en vez de O(n¬≤)) ---
            const clientIndexMap = React.useMemo(() => {
                const map = {};
                const visible = getVisibleClients(selectedDay);
                visible.forEach((c, i) => { map[c.id] = i; });
                return map;
            }, [getVisibleClients, selectedDay]);

            const handleGoogleLogin = async () => { try { await auth.signInWithPopup(googleProvider); } catch (error) { alert("Error: " + error.message); } };
            const handleLogout = () => { if(confirm("¬øCerrar sesi√≥n?")) auth.signOut(); };
            const isShortLink = (input) => input && (input.includes("goo.gl") || input.includes("maps.app.goo.gl") || input.includes("google.com/maps"));
            const parseLocationInput = (input) => { if (!input) return null; const m = input.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/); if(m) return {lat:m[1],lng:m[2]}; return null; }; 
            
            // --- NUEVA FUNCI√ìN HANDLEInputChange ---
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const updates = { [name]: value };
                    if (name === 'specificDate' && value) {
                        const d = new Date(value + 'T12:00:00');
                        const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                        const dayName = days[d.getDay()];
                        updates.visitDay = dayName;
                        updates.visitDays = [dayName];
                    }
                    if (name === 'freq' && value === 'on_demand') {
                        updates.visitDay = 'Sin Asignar';
                        updates.visitDays = [];
                    }
                    return { ...prev, ...updates };
                });
            };
            
            const handleProductChange = (prodId, val) => {
                setFormData(prev => ({
                    ...prev,
                    products: { ...prev.products, [prodId]: val }
                }));
            };

            const resetForm = () => { 
                setFormData({ 
                    name: '', phone: '', address: '', lat: '', lng: '', freq: 'weekly', visitDay: 'Lunes', visitDays: ['Lunes'], notes: '', locationInput: '', specificDate: '',
                    products: { b20: '', b12: '', b6: '', soda: '', bombita: '', disp_elec_new: '', disp_elec_chg: '', disp_nat: '' }
                }); 
                setEditingId(null); 
            };
            const editClient = (c) => { 
                setFormData({
                    ...c, 
                    locationInput: c.mapsLink || (c.lat ? `${c.lat},${c.lng}` : ''),
                    visitDays: c.visitDays || (c.visitDay ? [c.visitDay] : ['Lunes']),
                    products: c.products || { b20: '', b12: '', b6: '', soda: '', bombita: '', disp_elec_new: '', disp_elec_chg: '', disp_nat: '' }
                }); 
                setEditingId(c.id); 
                setView('add'); 
            };
            
            // --- NORMALIZACI√ìN DE TEL√âFONO (Uruguay +598) ---
            const normalizePhone = (phone) => {
                if (!phone) return '';
                let clean = phone.replace(/\D/g, '');
                if (clean.startsWith('598')) return clean;
                if (clean.startsWith('0')) return '598' + clean.slice(1);
                if (clean.length === 8 && clean.startsWith('9')) return '598' + clean;
                return '598' + clean;
            };

            // IMPLEMENTACI√ìN DE sendPhotoWhatsApp
            const sendPhotoWhatsApp = (phone) => {
                 if (!phone) return;
                 const cleanPhone = normalizePhone(phone);
                 window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}`, '_top');
            };

            const sendWhatsApp = (phone) => {
                if (!phone) return;
                const cleanPhone = normalizePhone(phone);
                const msg = encodeURIComponent("Buenas üöö. Ya estamos en camino, sos el/la siguiente en la lista de entrega. ¬°Nos vemos en unos minutos!\n\nAquapura");
                window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}&text=${msg}`, '_top');
            };

            const sendWhatsAppDirect = (phone) => {
                if (!phone) return;
                const cleanPhone = normalizePhone(phone);
                window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}`, '_top');
            };

            const sendDebtReminder = (phone) => {
                if (!phone) return;
                const cleanPhone = normalizePhone(phone);
                const msg = encodeURIComponent("Hola, buenas üòä\nEste es un mensaje autom√°tico para informarle que, seg√∫n nuestros registros, qued√≥ pendiente un saldo por regularizar.\nCuando pueda, le agradecemos que nos indique en qu√© fecha podr√≠amos saldarlo. Si necesita nuevamente los datos de la cuenta, con gusto se los enviamos.\nMuchas gracias.");
                window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}&text=${msg}`, '_top');
            };

            const openGoogleMaps = (lat, lng, link) => { 
                let url = '';
                if(lat && lng) { url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`; } 
                else if(link) { url = link; } 
                else { alert("Ubicaci√≥n no disponible"); return; }
                window.open(url, '_top');
            };
            
             const handleLocationPaste = (e) => { 
                const value = e.target.value;
                const coords = parseLocationInput(value);
                if (coords) {
                    setFormData({...formData, locationInput: value, lat: coords.lat, lng: coords.lng});
                } else {
                    setFormData({...formData, locationInput: value});
                }
            };
            
            const handleSaveClient = async (e) => { 
                e.preventDefault();
                // Solo admin puede crear/editar clientes
                if (!isAdmin) { alert("No tienes permisos para editar clientes."); return; }
                const hasCoordinates = formData.lat && formData.lng;
                const hasMapLink = formData.locationInput && isShortLink(formData.locationInput);
                if (!hasCoordinates && !hasMapLink) { alert("Por favor, ingresa una ubicaci√≥n v√°lida."); return; }
                try {
                    const currentWeek = getWeekNumber(new Date());
                    let visitDays = formData.visitDays && formData.visitDays.length > 0 ? formData.visitDays : [formData.visitDay];

                    // Si tiene fecha espec√≠fica, forzar visitDays al d√≠a de esa fecha
                    if (formData.specificDate) {
                        const d = new Date(formData.specificDate + 'T12:00:00');
                        const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                        const derivedDay = dayNames[d.getDay()];
                        visitDays = [derivedDay];
                    }

                    // Validaci√≥n: asegurar que hay d√≠as v√°lidos si no es on_demand
                    if (formData.freq !== 'on_demand' && (visitDays.length === 0 || visitDays.includes('Sin Asignar'))) {
                        alert("Por favor, selecciona al menos un d√≠a de visita v√°lido.");
                        return;
                    }
                    
                    const data = {
                        ...formData,
                        ...getDataScope(),
                        userId: user.uid,
                        updatedAt: new Date(),
                        startWeek: currentWeek,
                        visitDays: visitDays,
                        visitDay: visitDays[0] || 'Sin Asignar', // Mantener compatibilidad
                        isPinned: false,
                        mapsLink: formData.locationInput
                    };
                    
                    if (editingId) { 
                        // Al editar, solo agregar listOrders para d√≠as NUEVOS que no exist√≠an
                        const existingListOrders = formData.listOrders || {};
                        const newListOrders = { ...existingListOrders };
                        visitDays.forEach(day => {
                            if (newListOrders[day] === undefined) {
                                // Calcular siguiente orden para el d√≠a nuevo
                                const existingInDay = clients.filter(c => 
                                    c.id !== editingId &&
                                    c.freq !== 'on_demand' && 
                                    !c.isCompleted && 
                                    ((c.visitDays && c.visitDays.includes(day)) || c.visitDay === day)
                                );
                                const maxOrder = existingInDay.length > 0
                                    ? Math.max(...existingInDay.map(c => (c.listOrders?.[day] ?? c.listOrder ?? 0)))
                                    : -1;
                                newListOrders[day] = maxOrder + 1;
                            }
                        });
                        // Limpiar d√≠as que ya no est√°n seleccionados
                        Object.keys(newListOrders).forEach(day => {
                            if (!visitDays.includes(day)) {
                                delete newListOrders[day];
                            }
                        });
                        data.listOrders = newListOrders;
                        delete data.listOrder; // No sobrescribir listOrder general
                        await db.collection('clients').doc(editingId).update(data); 
                    } else { 
                        // Cliente nuevo - crear listOrders con n√∫mero secuencial para cada d√≠a
                        const listOrders = {};
                        visitDays.forEach(day => {
                            const existingInDay = clients.filter(c => 
                                c.freq !== 'on_demand' && 
                                !c.isCompleted && 
                                ((c.visitDays && c.visitDays.includes(day)) || c.visitDay === day)
                            );
                            
                            if (formData.freq === 'once') {
                                // Pedido de una vez: va al INICIO
                                let minOrder = 0;
                                if (existingInDay.length > 0) {
                                    const orders = existingInDay.map(c => {
                                        const order = c.listOrders?.[day] ?? c.listOrder ?? 0;
                                        return order > 100000 ? 0 : order;
                                    });
                                    minOrder = Math.min(...orders);
                                }
                                listOrders[day] = minOrder - 1;
                            } else {
                                // Pedido semanal: va al FINAL
                                let maxOrder = -1;
                                if (existingInDay.length > 0) {
                                    const orders = existingInDay.map(c => {
                                        const order = c.listOrders?.[day] ?? c.listOrder ?? 0;
                                        return order > 100000 ? 0 : order;
                                    });
                                    maxOrder = Math.max(...orders);
                                }
                                listOrders[day] = maxOrder + 1;
                            }
                        });
                        data.listOrder = listOrders[visitDays[0]];
                        data.listOrders = listOrders;
                        await db.collection('clients').add(data); 
                    }
                    resetForm(); setView('list');
                } catch(e) { alert("Error guardando."); }
            };
            const handleScheduleFromDirectory = async (clientData, newDays, newFreq, newDate, newNotes, newProducts) => {
                 try {
                    const currentWeek = getWeekNumber(new Date());
                    const newData = {
                        name: clientData.name, phone: clientData.phone, address: clientData.address, lat: clientData.lat, lng: clientData.lng, mapsLink: clientData.mapsLink,
                        ...getDataScope(),
                        userId: user.uid,
                        freq: newFreq, updatedAt: new Date(), 
                        notes: newNotes, isPinned: false,
                        products: newProducts || {} 
                    };
                    
                    if (newDate) {
                         // Pedido de una vez - siempre al INICIO con n√∫mero negativo
                         const d = new Date(newDate + 'T12:00:00'); 
                         const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                         const dayName = days[d.getDay()];
                         
                         // Encontrar el m√≠nimo orden existente y restar 1 para ir antes
                         const existingInDay = clients.filter(c => 
                            c.freq !== 'on_demand' && 
                            !c.isCompleted && 
                            ((c.visitDays && c.visitDays.includes(dayName)) || c.visitDay === dayName)
                         );
                         
                         // Calcular el orden m√≠nimo (puede ser negativo o positivo)
                         let minOrder = 0;
                         if (existingInDay.length > 0) {
                             const orders = existingInDay.map(c => {
                                 const order = c.listOrders?.[dayName] ?? c.listOrder ?? 0;
                                 // Ignorar timestamps muy grandes
                                 return order > 100000 ? 0 : order;
                             });
                             minOrder = Math.min(...orders);
                         }
                         // Nuevo pedido va ANTES de todo (minOrder - 1)
                         const newOrder = minOrder - 1;
                         
                         newData.visitDay = dayName;
                         newData.visitDays = [dayName];
                         newData.specificDate = newDate; 
                         newData.startWeek = currentWeek;
                         newData.listOrder = newOrder;
                         newData.listOrders = { [dayName]: newOrder };
                    } else {
                         // Pedido semanal - agregar al final con n√∫mero secuencial
                         newData.visitDays = newDays;
                         newData.visitDay = newDays[0];
                         newData.startWeek = currentWeek;
                         newData.specificDate = null;
                         
                         // Calcular el siguiente orden para cada d√≠a
                         const listOrders = {};
                         newDays.forEach(day => {
                             const existingInDay = clients.filter(c => 
                                c.freq !== 'on_demand' && 
                                !c.isCompleted && 
                                ((c.visitDays && c.visitDays.includes(day)) || c.visitDay === day)
                             );
                             // Encontrar el m√°ximo orden actual y sumar 1
                             const maxOrder = existingInDay.length > 0
                                ? Math.max(...existingInDay.map(c => (c.listOrders?.[day] ?? c.listOrder ?? 0)))
                                : -1;
                             listOrders[day] = maxOrder + 1;
                         });
                         newData.listOrders = listOrders;
                         newData.listOrder = listOrders[newDays[0]];
                    }
                    
                    if (clientData.freq === 'on_demand' || clientData.visitDay === 'Sin Asignar') { 
                        await db.collection('clients').doc(clientData.id).update(newData); 
                        alert("¬°Cliente reactivado!"); 
                    } else { 
                        newData.createdAt = new Date(); 
                        await db.collection('clients').add(newData); 
                        alert("¬°Visita adicional creada!"); 
                    }
                    setScheduleClient(null); 
                    setSelectedDay(newData.visitDays[0]); 
                    setView('list');
                } catch(e) { console.error(e); alert("Error al agendar: " + e.message); }
            };
            const handleDeleteClient = (id) => { 
                if (!isAdmin) { alert("No tienes permisos para quitar clientes."); return; }
                setConfirmModal({ isOpen: true, title: '¬øQuitar de la lista?', message: 'Se guardar√° en el Directorio.', confirmText: "Quitar", isDanger: false, action: async () => { await db.collection('clients').doc(id).update({ freq: 'on_demand', visitDay: 'Sin Asignar', visitDays: [] }); setConfirmModal(prev => ({...prev, isOpen: false})); } }); 
            };
            const handleDeletePermanently = (id) => { 
                if (!isAdmin) { alert("No tienes permisos para eliminar clientes."); return; }
                setConfirmModal({ isOpen: true, title: '¬øEliminar Definitivamente?', message: 'Se borrar√° para siempre.', isDanger: true, action: async () => { 
                try {
                    // Eliminar deudas asociadas
                    const clientDebts = debts.filter(d => d.clientId === id);
                    for (const d of clientDebts) { await db.collection('debts').doc(d.id).delete(); }
                    // Eliminar transferencias asociadas
                    const clientTransfers = transfers.filter(t => t.clientId === id);
                    for (const t of clientTransfers) { await db.collection('transfers').doc(t.id).delete(); }
                    // Eliminar cliente
                    await db.collection('clients').doc(id).delete();
                } catch(e) { console.error("Error eliminando cliente:", e); }
                setConfirmModal(prev => ({...prev, isOpen: false})); 
            } }); };
            
            const parseContactString = (str) => {
                // --- PARSER INTELIGENTE DE FORMATO DE PEDIDOS ---
                
                // 0. Limpiar caracteres de formato de WhatsApp/mensajer√≠a (* _ ~ `)
                str = str.replace(/\*/g, '').replace(/(?:^|\s)_([^_]+)_(?:\s|$)/g, ' $1 ');
                
                const lines = str.split('\n').map(l => l.trim()).filter(l => l);
                
                let name = '', address = '', phone = '', link = '', lat = '', lng = '', notes = '';
                const products = { b20: '', b12: '', b6: '', soda: '', bombita: '', disp_elec_new: '', disp_elec_chg: '', disp_nat: '' };

                // 1. Extraer URL de Google Maps
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const urls = str.match(urlRegex);
                if (urls) {
                    link = urls[0];
                    const m = link.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (m) { lat = m[1]; lng = m[2]; }
                }

                // 2. Extraer tel√©fono (buscar l√≠nea con "Tel√©fono:" o un n√∫mero de 8+ d√≠gitos)
                for (const line of lines) {
                    const telMatch = line.match(/tel[e√©]fono\s*:\s*(\d[\d\s\-]*)/i);
                    if (telMatch) { phone = telMatch[1].replace(/[\s\-]/g, ''); continue; }
                }
                // Si no se encontr√≥ con etiqueta, buscar n√∫mero suelto de 8+ d√≠gitos
                if (!phone) {
                    for (const line of lines) {
                        if (line.match(urlRegex)) continue; // Saltar URLs
                        const numMatch = line.match(/\b(0\d{8,})\b/);
                        if (numMatch) { phone = numMatch[1]; break; }
                    }
                }

                // 3. Extraer nombre (buscar "Nombre:" o primera l√≠nea significativa)
                for (const line of lines) {
                    const nameMatch = line.match(/nombre\s*:\s*(.+)/i);
                    if (nameMatch) { name = nameMatch[1].trim(); break; }
                }

                // 4. Extraer direcci√≥n + esquina
                let direccion = '', esquina = '';
                for (const line of lines) {
                    const dirMatch = line.match(/direcci[o√≥]n\s*:\s*(.+)/i);
                    if (dirMatch) { direccion = dirMatch[1].trim(); }
                    const esqMatch = line.match(/esquina\s*:\s*(.+)/i);
                    if (esqMatch) { esquina = esqMatch[1].trim(); }
                }
                if (direccion && esquina) { address = direccion + ' (esq. ' + esquina + ')'; }
                else if (direccion) { address = direccion; }

                // 5. Extraer productos
                const fullText = str.toLowerCase();
                
                // Bidones 20L
                const b20Match = fullText.match(/bid[o√≥]n[:\s]*20\s*(?:lts?|litros?)?\s*(\d+)/i) || fullText.match(/20\s*(?:lts?|litros?)\s*(\d+)/i);
                if (b20Match) products.b20 = b20Match[1];
                
                // Bidones 12L
                const b12Match = fullText.match(/bid[o√≥]n[:\s]*12\s*(?:lts?|litros?)?\s*(\d+)/i) || fullText.match(/12\s*(?:lts?|litros?)\s*(\d+)/i);
                if (b12Match) products.b12 = b12Match[1];
                
                // Bidones 6L
                const b6Match = fullText.match(/bid[o√≥]n[:\s]*6\s*(?:lts?|litros?)?\s*(\d+)/i) || fullText.match(/6\s*(?:lts?|litros?)\s*(\d+)/i);
                if (b6Match) products.b6 = b6Match[1];
                
                // Soda (solo si cantidad > 0)
                const sodaMatch = fullText.match(/soda\s*:\s*(\d+)/i);
                if (sodaMatch && parseInt(sodaMatch[1]) > 0) products.soda = sodaMatch[1];
                
                // Bombita
                const bombitaMatch = fullText.match(/bombita\s*:?\s*(\d+)/i);
                if (bombitaMatch && parseInt(bombitaMatch[1]) > 0) products.bombita = bombitaMatch[1];
                
                // Dispensador El√©ctrico Nuevo
                const dispElecNewMatch = fullText.match(/dispensador\s*:?\s*(?:elec(?:trico)?|el√©(?:ctrico)?)\s*(?:nuevo)?\s*(\d+)/i) || fullText.match(/disp(?:ensador)?\s*:?\s*elec\s*(\d+)/i);
                if (dispElecNewMatch && parseInt(dispElecNewMatch[1]) > 0) products.disp_elec_new = dispElecNewMatch[1];
                
                // Dispensador El√©ctrico Cambio
                const dispElecChgMatch = fullText.match(/dispensador\s*:?\s*(?:elec(?:trico)?|el√©(?:ctrico)?)\s*cambio\s*(\d+)/i);
                if (dispElecChgMatch && parseInt(dispElecChgMatch[1]) > 0) products.disp_elec_chg = dispElecChgMatch[1];
                
                // Dispensador Natural
                const dispNatMatch = fullText.match(/dispensador\s*:?\s*nat(?:ural)?\s*(\d+)/i) || fullText.match(/disp(?:ensador)?\s*:?\s*nat\s*(\d+)/i);
                if (dispNatMatch && parseInt(dispNatMatch[1]) > 0) products.disp_nat = dispNatMatch[1];

                // 6. Extraer notas/detalle (el √∫ltimo "Detalle:" con texto largo, o texto despu√©s de productos)
                const detalles = [];
                let isAfterProducts = false;
                for (const line of lines) {
                    if (/producto|bidon|soda|dispensador/i.test(line)) { isAfterProducts = true; }
                    const detMatch = line.match(/detalle\s*:\s*(.+)/i);
                    if (detMatch) {
                        const detText = detMatch[1].trim();
                        // Si es solo una zona (LAGOMAR, SOLYMAR, etc.) -> agregar a direcci√≥n
                        if (detText.length <= 20 && !isAfterProducts && !/nuevo|coordinar|espera|llam/i.test(detText)) {
                            if (address) address += ' - ' + detText;
                            else address = detText;
                        } else if (isAfterProducts || detText.length > 20 || /nuevo|coordinar|espera|llam/i.test(detText)) {
                            detalles.push(detText);
                        }
                    }
                }
                notes = detalles.join(' | ');

                // 7. Fallback: si no se encontr√≥ formato etiquetado, usar parser simple anterior
                if (!name && !address && !phone) {
                    let cleanStr = str.replace(link, '').trim().replace(/-+$/, '').trim();
                    const parts = cleanStr.split(/\s+-\s+/).map(s => s.trim()).filter(s => s);
                    if (parts.length >= 2) { name = parts[0]; address = parts.slice(1).join(' - '); }
                    else if (parts.length === 1) { name = parts[0]; address = parts[0]; }
                }

                return { name, address, phone, link, lat, lng, products, notes };
            };

             const handleMagicPaste = (text) => {
                 const parsed = parseContactString(text);
                 if (!parsed.name && !parsed.link) { alert("No se pudo detectar el formato."); return; }
                 if (view === 'add') {
                     if (!isAdmin) { alert("No tienes permisos para agregar clientes."); return; }
                     setFormData(prev => ({ 
                         ...prev, 
                         name: parsed.name, 
                         address: parsed.address, 
                         phone: parsed.phone || prev.phone,
                         locationInput: parsed.link, 
                         lat: parsed.lat, 
                         lng: parsed.lng,
                         notes: parsed.notes || prev.notes,
                         products: {
                             ...prev.products,
                             ...Object.fromEntries(
                                 Object.entries(parsed.products).filter(([k, v]) => v !== '')
                             )
                         }
                     }));
                     setShowPasteModal(false);
                 } else {
                     if (!isAdmin) { alert("No tienes permisos para importar clientes."); return; }
                     const currentWeek = getWeekNumber(new Date());
                     const cleanProducts = Object.fromEntries(
                         Object.entries(parsed.products).filter(([k, v]) => v !== '').map(([k, v]) => [k, parseInt(v) || 0])
                     );
                     const newData = {
                         name: parsed.name, phone: parsed.phone || '', address: parsed.address, lat: parsed.lat || null, lng: parsed.lng || null, mapsLink: parsed.link, ...getDataScope(), userId: user.uid, freq: 'on_demand', visitDay: 'Sin Asignar', notes: parsed.notes || '', updatedAt: new Date(), startWeek: currentWeek, listOrder: Date.now(), isPinned: false, products: cleanProducts
                     };
                     db.collection('clients').add(newData).then(() => { alert("Importado al Directorio."); setShowPasteModal(false); });
                 }
            };

            const filteredDirectory = React.useMemo(() => {
                return clients
                    .filter(c => {
                        const term = normalizeText(debouncedSearch);
                        const name = normalizeText(c.name || '');
                        const address = normalizeText(c.address || '');
                        const phone = (c.phone || '').toLowerCase();
                        return name.includes(term) || address.includes(term) || phone.includes(term);
                    })
                    // Filter duplicates by phone number logic
                    .reduce((unique, item) => {
                        // Normalize phone to digits for key
                        const key = item.phone ? item.phone.replace(/\D/g, '') : item.id;
                        // If phone is empty/short, don't dedupe by it, use ID
                        if (!item.phone || item.phone.length < 6) {
                            unique.push(item);
                            return unique;
                        }
                        // If duplicate found, keep the one with most recent updatedAt
                        const existingIndex = unique.findIndex(u => u.phone && u.phone.replace(/\D/g, '') === key);
                        if (existingIndex > -1) {
                            const existing = unique[existingIndex];
                            // Firestore seconds ‚Üí milliseconds para Date
                            if (new Date((item.updatedAt?.seconds || 0) * 1000) > new Date((existing.updatedAt?.seconds || 0) * 1000)) {
                                unique[existingIndex] = item;
                            }
                        } else {
                            unique.push(item);
                        }
                        return unique;
                    }, [])
                    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }, [clients, debouncedSearch]);
            
            const handleExportClients = () => {
                try {
                    const allClients = clients.filter(c => c.name);
                    if (allClients.length === 0) { alert("No hay clientes para exportar."); return; }

                    // Headers del CSV
                    const headers = ['Nombre', 'Tel√©fono', 'Direcci√≥n', 'D√≠a', 'Frecuencia', 'Productos', 'Notas', 'Tiene Deuda', 'Favorito', 'Link Maps'];
                    
                    const freqLabels = { weekly: 'Semanal', biweekly: 'Cada 2 sem', triweekly: 'Cada 3 sem', monthly: 'Cada 4 sem', once: 'Una vez', on_demand: 'Archivado' };
                    
                    const rows = allClients.map(c => {
                        // Armar resumen de productos
                        let prodParts = [];
                        if (c.products) {
                            PRODUCTS.forEach(p => {
                                const qty = parseInt(c.products[p.id] || 0);
                                if (qty > 0) prodParts.push(`${p.label}: ${qty}`);
                            });
                        }
                        
                        return [
                            c.name || '',
                            c.phone || '',
                            c.address || '',
                            c.visitDay || '',
                            freqLabels[c.freq] || c.freq || '',
                            prodParts.join(', '),
                            c.notes || '',
                            c.hasDebt ? 'S√≠' : 'No',
                            c.isStarred ? 'S√≠' : 'No',
                            c.mapsLink || ''
                        ];
                    });
                    
                    // Escapar campos CSV
                    const escapeCsv = (val) => {
                        const str = String(val);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    };
                    
                    // BOM para que Excel/Sheets reconozca UTF-8
                    const bom = '\uFEFF';
                    const csvContent = bom + [
                        headers.map(escapeCsv).join(','),
                        ...rows.map(row => row.map(escapeCsv).join(','))
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const date = new Date().toISOString().split('T')[0];
                    link.href = url;
                    link.download = `RutaWater_Clientes_${date}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showUndoToast(`${allClients.length} clientes exportados`, null);
                } catch(e) { 
                    console.error("Error exportando:", e); 
                    alert("Error al exportar: " + e.message); 
                }
            };

            const changeClientPosition = async (clientId, newPosStr) => {
                const newPos = parseInt(newPosStr, 10);
                if (isNaN(newPos) || newPos < 1) return; 
                
                const dayToFilter = selectedDay;
                // Get visible clients in current sorted order (hacer copia)
                const dayClients = [...getVisibleClients(dayToFilter)];

                const currentIndex = dayClients.findIndex(c => c.id === clientId);
                if (currentIndex === -1) return;

                const [movedClient] = dayClients.splice(currentIndex, 1);
                // Adjust index for human (1-based) to array (0-based)
                const targetIndex = Math.min(Math.max(0, newPos - 1), dayClients.length);
                dayClients.splice(targetIndex, 0, movedClient);

                const batch = db.batch();
                // Re-assign sequential order (0, 1, 2, 3...) for ALL clients in this day
                dayClients.forEach((client, index) => {
                    const ref = db.collection('clients').doc(client.id);
                    
                    // Solo actualizar listOrders para el d√≠a espec√≠fico
                    // Si el cliente tiene m√∫ltiples d√≠as, no tocar los otros
                    const hasMultipleDays = client.visitDays && client.visitDays.length > 1;
                    
                    if (hasMultipleDays) {
                        // Solo actualizar el d√≠a espec√≠fico
                        batch.update(ref, { [`listOrders.${dayToFilter}`]: index });
                    } else {
                        // Cliente de un solo d√≠a: actualizar ambos para consistencia
                        batch.update(ref, { 
                            [`listOrders.${dayToFilter}`]: index,
                            listOrder: index
                        });
                    }
                });

                await batch.commit();
            };

            if (loadingAuth) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold">Cargando...</div>;
            if (!user) return <LoginScreen onLogin={handleGoogleLogin} />;

            return (
                <div className={`min-h-screen bg-gray-50 dark:bg-gray-900 font-sans ${activeSection === 'cartera' ? 'pb-24' : 'pb-6'} relative`}>
                    {/* MODALES: renderizado condicional para evitar reconciliaci√≥n innecesaria */}
                    {confirmModal.isOpen && <ConfirmModal isOpen={true} title={confirmModal.title} message={confirmModal.message} confirmText={confirmModal.confirmText} cancelText={confirmModal.cancelText} isDanger={confirmModal.isDanger} onConfirm={confirmModal.action} onCancel={() => setConfirmModal({ ...confirmModal, isOpen: false })} />}
                    {scheduleClient && <ScheduleModal isOpen={true} client={scheduleClient} onClose={() => setScheduleClient(null)} onSave={handleScheduleFromDirectory} />}
                    {showPasteModal && <PasteContactModal isOpen={true} onClose={() => setShowPasteModal(false)} onPaste={handleMagicPaste} />}
                    {alarmModal.isOpen && <AlarmModal isOpen={true} initialValue={alarmModal.currentVal} onClose={() => setAlarmModal({isOpen: false, clientId: null, currentVal: ''})} onSave={handleSaveAlarm} />}
                    {showGroupModal && <GroupModal
                        isOpen={true}
                        onClose={() => setShowGroupModal(false)}
                        user={user}
                        groupData={groupData}
                        onGroupUpdate={(newGroupData) => {
                            setGroupData(newGroupData);
                        }}
                    />}
                    {debtModal.isOpen && <DebtModal isOpen={true} client={debtModal.client} onClose={() => setDebtModal({ isOpen: false, client: null })} onSave={handleAddDebt} />}
                    {editDebtModal.isOpen && <EditDebtModal isOpen={true} debt={editDebtModal.debt} onClose={() => setEditDebtModal({ isOpen: false, debt: null })} onSave={handleEditDebt} />}
                    {viewDebtModal.isOpen && <ViewDebtModal
                        isOpen={true}
                        client={viewDebtModal.client}
                        debts={debts}
                        onClose={() => setViewDebtModal({ isOpen: false, client: null })}
                        onPaid={(debt) => {
                            setViewDebtModal({ isOpen: false, client: null });
                            setConfirmModal({
                                isOpen: true, title: '¬øDeuda pagada?',
                                message: `Confirmar que ${debt.clientName} pag√≥ $${debt.amount?.toLocaleString()}`,
                                confirmText: "Pagada", isDanger: false,
                                action: async () => {
                                    await handleDebtPaid(debt);
                                    setConfirmModal(prev => ({...prev, isOpen: false}));
                                }
                            });
                        }}
                        onEdit={(debt) => setEditDebtModal({ isOpen: true, debt })}
                        onAddMore={(client) => setDebtModal({ isOpen: true, client })}
                    />}
                    {activeAlert && <AlarmBanner data={activeAlert} onClose={handleDismissAlert} />}

                    {/* TOAST NOTIFICATION */}
                    {toast && <Toast message={toast.message} onUndo={handleUndo} hasUndo={!!toast.undoAction} />}

                    <header className="bg-blue-600 dark:bg-gray-800 text-white p-4 shadow-lg sticky top-0 z-10 transition-colors duration-200">
                        <div className="flex justify-between items-center max-w-2xl mx-auto">
                            <div 
                                className="flex items-center gap-2 cursor-pointer active:opacity-80 transition-opacity" 
                                onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                            >
                                <Icons.Truck className="w-6 h-6" />
                                <h1 className="text-xl font-bold">RutaWater</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* SELECTOR DE SECCI√ìN */}
                                <div className="relative">
                                    <button 
                                        onClick={() => setShowSectionMenu(!showSectionMenu)} 
                                        className="flex items-center gap-1.5 bg-white/15 hover:bg-white/25 active:bg-white/30 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors"
                                    >
                                        {activeSection === 'cartera' && <><Icons.Users size={15}/> Cartera</>}
                                        {activeSection === 'deudas' && <><Icons.DollarSign size={15}/> Deudas</>}
                                        {activeSection === 'transferencias' && <><Icons.CreditCard size={15}/> Transferencias</>}
                                        <Icons.ChevronDown size={14} className={`transition-transform duration-200 ${showSectionMenu ? 'rotate-180' : ''}`} />
                                        {/* Badges de pendientes */}
                                        {activeSection !== 'deudas' && debts.length > 0 && (
                                            <span className="bg-red-500 text-white text-[9px] font-black min-w-[16px] h-4 rounded-full flex items-center justify-center px-1">{debts.length}</span>
                                        )}
                                        {activeSection !== 'transferencias' && transfers.length > 0 && (
                                            <span className="bg-emerald-500 text-white text-[9px] font-black min-w-[16px] h-4 rounded-full flex items-center justify-center px-1">{transfers.length}</span>
                                        )}
                                    </button>
                                    {showSectionMenu && (
                                        <>
                                            <div className="fixed inset-0 z-20" onClick={() => setShowSectionMenu(false)} />
                                            <div className="absolute right-0 top-10 z-30 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-56 overflow-hidden" style={{animation: 'slideUpFade 0.2s ease-out forwards'}}>
                                                <button
                                                    onClick={() => { setActiveSection('cartera'); setShowSectionMenu(false); setView('list'); }}
                                                    className={`w-full flex items-center gap-3 px-4 py-3 text-sm transition-colors ${activeSection === 'cartera' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-bold' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
                                                >
                                                    <Icons.Users size={18} />
                                                    <span className="flex-1 text-left">Cartera de Clientes</span>
                                                </button>
                                                <div className="border-t border-gray-100 dark:border-gray-700" />
                                                <button
                                                    onClick={() => { setActiveSection('deudas'); setShowSectionMenu(false); }}
                                                    className={`w-full flex items-center gap-3 px-4 py-3 text-sm transition-colors ${activeSection === 'deudas' ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 font-bold' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
                                                >
                                                    <Icons.DollarSign size={18} />
                                                    <span className="flex-1 text-left">Deudas de Clientes</span>
                                                    {debts.length > 0 && <span className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-bold px-2 py-0.5 rounded-full">{debts.length}</span>}
                                                </button>
                                                <div className="border-t border-gray-100 dark:border-gray-700" />
                                                <button
                                                    onClick={() => { setActiveSection('transferencias'); setShowSectionMenu(false); }}
                                                    className={`w-full flex items-center gap-3 px-4 py-3 text-sm transition-colors ${activeSection === 'transferencias' ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-300 font-bold' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
                                                >
                                                    <Icons.CreditCard size={18} />
                                                    <span className="flex-1 text-left">Revisar Transferencias</span>
                                                    {transfers.length > 0 && <span className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs font-bold px-2 py-0.5 rounded-full">{transfers.length}</span>}
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                                {/* Bot√≥n Grupo Familiar */}
                                <button 
                                    onClick={() => setShowGroupModal(true)}
                                    className={`p-1.5 rounded-lg transition-colors ${groupData?.groupId ? 'bg-purple-500/20 text-purple-200' : 'hover:bg-white/10'}`}
                                    title={groupData?.groupId ? (groupData.role === 'admin' ? 'Grupo (Admin)' : 'Grupo (Miembro)') : 'Grupo Familiar'}
                                >
                                    <Icons.Users className="w-5 h-5" />
                                </button>
                                <button onClick={handleLogout}><Icons.LogOut className="w-5 h-5" /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto p-4">
                        {/* ==================== SECCI√ìN: CARTERA DE CLIENTES ==================== */}
                        {activeSection === 'cartera' && (
                        <>
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'].map(day => (
                                        <button key={day} onClick={() => { setSelectedDay(day); setListSearchTerm(''); setActiveFilters([]); setShowFilterMenu(false); }} className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors duration-200 ${selectedDay === day ? 'bg-blue-600 dark:bg-blue-700 text-white' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700'}`}>{day}</button>
                                    ))}
                                </div>
                                {selectedDay !== '' && (
                                    <>
                                        {/* TOTAL LOADS COUNTER (Dynamic) */}
                                        <ProductCounter clients={activeClientsForCounter} />
                                        
                                        {/* BARRA DE B√öSQUEDA Y FILTRO */}
                                        <div className="flex gap-2 items-center">
                                            <div className="flex-1 relative">
                                                <input 
                                                    type="text" 
                                                    placeholder="Buscar por nombre o direcci√≥n..." 
                                                    value={listSearchTerm} 
                                                    onChange={(e) => setListSearchTerm(e.target.value)} 
                                                    className="w-full pl-9 pr-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg outline-none dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-sm"
                                                />
                                                <div className="absolute left-3 top-2.5 text-gray-400 dark:text-gray-500">
                                                    <Icons.Search size={18} />
                                                </div>
                                                {listSearchTerm && (
                                                    <button 
                                                        onClick={() => setListSearchTerm('')}
                                                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                                                    >
                                                        <Icons.X size={18} />
                                                    </button>
                                                )}
                                            </div>
                                            <div className="relative">
                                                <button 
                                                    onClick={() => setShowFilterMenu(!showFilterMenu)}
                                                    className={`px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-1.5 transition-colors whitespace-nowrap ${
                                                        activeFilters.length > 0 
                                                            ? 'bg-blue-600 text-white shadow-md' 
                                                            : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700'
                                                    }`}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                                                    Filtros
                                                    {activeFilters.length > 0 && (
                                                        <span className="bg-white text-blue-600 text-[10px] font-black w-4 h-4 rounded-full flex items-center justify-center leading-none">{activeFilters.length}</span>
                                                    )}
                                                </button>

                                                {/* MEN√ö DESPLEGABLE DE FILTROS */}
                                                {showFilterMenu && (
                                                    <>
                                                        <div className="fixed inset-0 z-20" onClick={() => setShowFilterMenu(false)} />
                                                        <div className="absolute right-0 top-12 z-30 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-64 overflow-hidden" style={{animation: 'slideUpFade 0.2s ease-out forwards'}}>
                                                            {/* Header del men√∫ */}
                                                            <div className="flex justify-between items-center px-4 pt-3 pb-2 border-b border-gray-100 dark:border-gray-700">
                                                                <span className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filtros</span>
                                                                {activeFilters.length > 0 && (
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); setActiveFilters([]); }}
                                                                        className="text-[11px] text-red-500 dark:text-red-400 font-bold hover:text-red-600"
                                                                    >
                                                                        Limpiar todo
                                                                    </button>
                                                                )}
                                                            </div>

                                                            {/* Secci√≥n: Tipo de pedido */}
                                                            <div className="px-3 py-2">
                                                                <span className="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-1">Tipo</span>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setActiveFilters(prev => 
                                                                            prev.includes('once_starred') 
                                                                                ? prev.filter(f => f !== 'once_starred') 
                                                                                : [...prev, 'once_starred']
                                                                        );
                                                                    }}
                                                                    className={`w-full mt-1 flex items-center gap-2.5 px-3 py-2.5 rounded-lg text-sm transition-all ${
                                                                        activeFilters.includes('once_starred')
                                                                            ? 'bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 font-bold border border-orange-200 dark:border-orange-800'
                                                                            : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                                                                    }`}
                                                                >
                                                                    <Icons.Star size={15} fill={activeFilters.includes('once_starred') ? "currentColor" : "none"} />
                                                                    <span>Una vez / Favoritos</span>
                                                                    {activeFilters.includes('once_starred') && (
                                                                        <Icons.CheckCircle size={14} className="ml-auto text-orange-500" />
                                                                    )}
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setActiveFilters(prev => 
                                                                            prev.includes('has_debt') 
                                                                                ? prev.filter(f => f !== 'has_debt') 
                                                                                : [...prev, 'has_debt']
                                                                        );
                                                                    }}
                                                                    className={`w-full mt-1 flex items-center gap-2.5 px-3 py-2.5 rounded-lg text-sm transition-all ${
                                                                        activeFilters.includes('has_debt')
                                                                            ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 font-bold border border-red-200 dark:border-red-800'
                                                                            : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                                                                    }`}
                                                                >
                                                                    <Icons.DollarSign size={15} />
                                                                    <span>Con deuda</span>
                                                                    {activeFilters.includes('has_debt') && (
                                                                        <Icons.CheckCircle size={14} className="ml-auto text-red-500" />
                                                                    )}
                                                                </button>
                                                            </div>

                                                            {/* Separador */}
                                                            <div className="border-t border-gray-100 dark:border-gray-700" />

                                                            {/* Secci√≥n: Productos */}
                                                            <div className="px-3 py-2 pb-3">
                                                                <span className="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-1">Productos</span>
                                                                <div className="grid grid-cols-2 gap-1.5 mt-1.5">
                                                                    {PRODUCTS.map(prod => {
                                                                        const isActive = activeFilters.includes(prod.id);
                                                                        return (
                                                                            <button
                                                                                key={prod.id}
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    setActiveFilters(prev => 
                                                                                        prev.includes(prod.id)
                                                                                            ? prev.filter(f => f !== prod.id)
                                                                                            : [...prev, prod.id]
                                                                                    );
                                                                                }}
                                                                                className={`flex items-center gap-1.5 px-2.5 py-2 rounded-lg text-xs transition-all ${
                                                                                    isActive
                                                                                        ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-bold border border-blue-200 dark:border-blue-800'
                                                                                        : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 border border-transparent'
                                                                                }`}
                                                                            >
                                                                                <span>{prod.icon}</span>
                                                                                <span className="truncate">{prod.short}</span>
                                                                                {isActive && (
                                                                                    <Icons.CheckCircle size={12} className="ml-auto text-blue-500 shrink-0" />
                                                                                )}
                                                                            </button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* CHIPS DE FILTROS ACTIVOS */}
                                        {activeFilters.length > 0 && (
                                            <div className="flex flex-wrap gap-1.5">
                                                {activeFilters.map(filter => {
                                                    let label = '';
                                                    let bgColor = '';
                                                    if (filter === 'once_starred') {
                                                        label = '‚≠ê Una vez / Favoritos';
                                                        bgColor = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 border-orange-200 dark:border-orange-800';
                                                    } else if (filter === 'has_debt') {
                                                        label = 'üí≤ Con deuda';
                                                        bgColor = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 border-red-200 dark:border-red-800';
                                                    } else {
                                                        const prod = PRODUCTS.find(p => p.id === filter);
                                                        label = prod ? `${prod.icon} ${prod.label}` : filter;
                                                        bgColor = 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 border-blue-200 dark:border-blue-800';
                                                    }
                                                    return (
                                                        <button
                                                            key={filter}
                                                            onClick={() => setActiveFilters(prev => prev.filter(f => f !== filter))}
                                                            className={`inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-bold border transition-all active:scale-95 ${bgColor}`}
                                                        >
                                                            {label}
                                                            <Icons.X size={12} />
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </>
                                )}
                                {/* RENDERIZADO POR GRUPOS DE FECHA */}
                                {selectedDay !== '' ? (
                                    Object.keys(groupedClients).map(key => (
                                        <div key={key} className="mb-6">
                                            <h3 className="text-sm font-bold text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wider pl-2 border-l-4 border-blue-200 dark:border-blue-900">
                                                {groupedClients[key].label}
                                            </h3>
                                            <div id={`group-${key}`} className="grid gap-3">
                                                {groupedClients[key].items.map((client) => (
                                                    <ClientCard
                                                        key={client.id}
                                                        client={client}
                                                        trueIndex={clientIndexMap[client.id] ?? 0}
                                                        isAdmin={isAdmin}
                                                        onToggleStar={handleToggleStar}
                                                        onDebtClick={handleDebtClick}
                                                        onAddTransfer={handleAddTransfer}
                                                        onSetAlarm={handleSetAlarmForClient}
                                                        onEdit={editClient}
                                                        onDelete={handleDeleteClient}
                                                        onOpenMaps={openGoogleMaps}
                                                        onSendPhoto={sendPhotoWhatsApp}
                                                        onSendWhatsApp={sendWhatsApp}
                                                        onMarkDone={handleMarkAsDoneInList}
                                                        onChangePosition={changeClientPosition}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="grid gap-3">
                                        <p className="text-center text-gray-500 dark:text-gray-400 mt-10">Selecciona un d√≠a para ver la agenda organizada.</p>
                                    </div>
                                )}
                                
                                {/* SECCI√ìN COMPLETADOS */}
                                {selectedDay !== '' && getCompletedClients(selectedDay).length > 0 && (
                                    <div className="mt-8 pt-4 border-t-2 border-dashed border-gray-200 dark:border-gray-700">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-sm font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider flex items-center gap-2">
                                                <Icons.CheckCircle size={16} /> Completados ({getCompletedClients(selectedDay).length})
                                            </h3>
                                            <button 
                                                onClick={() => handleClearCompleted(selectedDay)}
                                                className="text-xs text-red-500 dark:text-red-400 font-medium flex items-center gap-1 hover:text-red-600 dark:hover:text-red-300 px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20"
                                            >
                                                <Icons.Trash2 size={14} /> Eliminar todos
                                            </button>
                                        </div>
                                        <div className="grid gap-2">
                                            {getCompletedClients(selectedDay).map(client => (
                                                <Card key={client.id} className="p-3 opacity-60 hover:opacity-100 transition-opacity bg-gray-50 dark:bg-gray-800/50">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center text-green-600 dark:text-green-400">
                                                                <Icons.CheckCircle size={18} />
                                                            </div>
                                                            <div>
                                                                <h4 className="font-medium text-gray-500 dark:text-gray-400 line-through">{(client.name || '').toUpperCase()}</h4>
                                                                <p className="text-xs text-gray-400 dark:text-gray-500">{client.address}</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => handleRestoreCompleted(client)}
                                                                className="px-3 py-1.5 bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 rounded-lg text-xs font-bold hover:bg-blue-200 dark:hover:bg-blue-800"
                                                            >
                                                                Restaurar
                                                            </button>
                                                            <button 
                                                                onClick={() => handleDeletePermanently(client.id)}
                                                                className="p-1.5 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400"
                                                            >
                                                                <Icons.Trash2 size={16} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </Card>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* VISTAS DIRECTORIO Y ADD IGUALES CON MODIFICACION DE FORMULARIO */}
                        {view === 'directory' && (
                            <div className="space-y-4">
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 sticky top-0 z-10">
                                    <div className="flex justify-between items-center mb-3">
                                        <h2 className="text-xl font-bold dark:text-white flex items-center gap-2"><Icons.Users /> Directorio</h2>
                                        <button onClick={handleExportClients} className="text-xs bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 px-3 py-1.5 rounded-full font-bold hover:bg-green-200 dark:hover:bg-green-800 flex items-center gap-1"><Icons.Import size={14} className="rotate-180" /> Exportar</button>
                                    </div>
                                    <div className="relative">
                                        <input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-10 py-3 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-lg outline-none dark:text-white placeholder-gray-400 dark:placeholder-gray-500" />
                                        <div className="absolute left-3 top-3.5 text-gray-400 dark:text-gray-500"><Icons.Search size={20} /></div>
                                        {searchTerm && (
                                            <button onClick={() => setSearchTerm('')} className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                                <Icons.X size={20} />
                                            </button>
                                        )}
                                    </div>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-2 text-center font-medium">{filteredDirectory.length} cliente{filteredDirectory.length !== 1 ? 's' : ''} en el directorio</p>
                                </div>
                                <div className="grid gap-3">
                                    {filteredDirectory.map(client => (
                                        <Card key={client.id} className="p-4 border-l-4 border-l-transparent hover:border-l-blue-500 dark:hover:border-l-blue-400">
                                            <div className="flex justify-between items-center">
                                                <div><h3 className="font-bold text-gray-900 dark:text-white">{(client.name || '').toUpperCase()}</h3><p className="text-sm text-gray-500 dark:text-gray-400">{client.address}</p></div>
                                                <div className="flex flex-col gap-2">
                                                    <button onClick={() => setScheduleClient(client)} className="px-3 py-1.5 bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 rounded-lg text-xs font-bold flex items-center gap-1"><Icons.Calendar size={14}/> Agendar</button>
                                                    {isAdmin && <div className="flex gap-1 self-end"><button onClick={() => editClient(client)} className="p-1.5 text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-400"><Icons.Edit size={16} /></button><button onClick={() => handleDeletePermanently(client.id)} className="p-1.5 text-gray-400 dark:text-gray-500 hover:text-red-600 dark:hover:text-red-400"><Icons.Trash2 size={16} /></button></div>}
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}
                         {view === 'add' && (
                            <form onSubmit={handleSaveClient} className="space-y-4">
                                <h2 className="text-xl font-bold dark:text-white flex items-center gap-2"><div className="bg-blue-600 text-white p-1 rounded"><Icons.Plus /></div> {editingId ? 'Editar' : 'Nuevo'} Cliente</h2>
                                
                                <div className="flex justify-end">
                                    <button type="button" onClick={() => setShowPasteModal(true)} className="text-xs text-blue-600 dark:text-blue-400 font-bold flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded border border-blue-200 dark:border-blue-800"><Icons.Clipboard size={14}/> Pegar Formato Contacto</button>
                                </div>

                                <input required name="name" value={formData.name} onChange={handleInputChange} className="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Nombre" />
                                <input name="phone" value={formData.phone} onChange={handleInputChange} className="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Tel√©fono" />
                                
                                {/* Selector de m√∫ltiples d√≠as */}
                                <div>
                                    <label className="block text-sm font-medium mb-2 dark:text-gray-300">D√≠as de Visita <span className="text-xs text-gray-400">(puede elegir varios)</span></label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'].map(day => (
                                            <button
                                                key={day}
                                                type="button"
                                                onClick={() => {
                                                    const current = formData.visitDays || [formData.visitDay];
                                                    if (current.includes(day)) {
                                                        if (current.length > 1) {
                                                            const newDays = current.filter(d => d !== day);
                                                            setFormData({...formData, visitDays: newDays, visitDay: newDays[0]});
                                                        }
                                                    } else {
                                                        const newDays = [...current, day];
                                                        setFormData({...formData, visitDays: newDays, visitDay: newDays[0]});
                                                    }
                                                }}
                                                className={`p-2.5 rounded-lg text-sm font-medium transition-all ${
                                                    (formData.visitDays || [formData.visitDay]).includes(day)
                                                        ? 'bg-blue-500 text-white shadow-md'
                                                        : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'
                                                }`}
                                            >
                                                {day.slice(0, 3)}
                                            </button>
                                        ))}
                                    </div>
                                    {(formData.visitDays || []).length > 1 && (
                                        <p className="text-xs text-blue-600 dark:text-blue-400 mt-2">üìÖ {(formData.visitDays || []).length} d√≠as seleccionados: {(formData.visitDays || []).join(', ')}</p>
                                    )}
                                </div>

                                <input required name="address" value={formData.address} onChange={handleInputChange} className="w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Direcci√≥n" />
                                <div className="bg-blue-50 dark:bg-gray-800 p-4 rounded-lg border border-blue-100 dark:border-gray-700">
                                    <label className="block text-sm font-bold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2"><Icons.MapPin size={16}/> Ubicaci√≥n (GPS/Link)</label>
                                    <div className="relative"><input type="text" value={formData.locationInput} onChange={handleLocationPaste} className="w-full p-3 pl-10 border rounded-lg outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Pega link de Maps..." /><div className="absolute left-3 top-3 text-gray-400"><Icons.Link size={20} /></div></div>
                                </div>
                                
                                {/* SECCI√ìN PRODUCTOS */}
                                <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">üì¶ Productos Habituales</label>
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                                        {PRODUCTS.map(prod => (
                                            <div key={prod.id} className="flex items-center justify-between bg-white dark:bg-gray-700 p-2 rounded border border-gray-200 dark:border-gray-600">
                                                <span className="text-xs font-medium flex items-center gap-1 dark:text-gray-300">{prod.icon} {prod.label}</span>
                                                <input 
                                                    type="number" 
                                                    placeholder="0" 
                                                    value={formData.products[prod.id] || ''}
                                                    onChange={(e) => handleProductChange(prod.id, e.target.value)}
                                                    className="w-12 p-1 text-center border rounded focus:ring-1 focus:ring-blue-500 outline-none text-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-2 dark:text-gray-300">Frecuencia</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {['weekly', 'once', 'biweekly', 'triweekly', 'monthly'].map(freqType => {
                                            let label = '';
                                            switch(freqType) {
                                                case 'weekly': label = 'Semanal'; break;
                                                case 'once': label = 'Una vez'; break;
                                                case 'biweekly': label = 'Cada 2 sem'; break;
                                                case 'triweekly': label = 'Cada 3 sem'; break;
                                                case 'monthly': label = 'Cada 4 sem'; break;
                                            }
                                            const isSelected = formData.freq === freqType;
                                            return (
                                                <label key={freqType} className={`flex items-center gap-2 border p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500 dark:border-blue-500 text-blue-700 dark:text-blue-300 font-bold' : 'border-gray-200 dark:border-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800'}`}>
                                                    <input type="radio" name="freq" value={freqType} checked={isSelected} onChange={handleInputChange} className="accent-blue-600" /> 
                                                    {label}
                                                </label>
                                            );
                                        })}
                                    </div>
                                    {/* NUEVA OPCI√ìN "SOLO DIRECTORIO" */}
                                    <label className={`flex items-center gap-2 border p-3 mt-2 rounded-lg cursor-pointer transition-colors ${formData.freq === 'on_demand' ? 'bg-gray-200 dark:bg-gray-700 border-gray-400 dark:border-gray-500 font-bold' : 'border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 dark:text-gray-300'}`}>
                                        <input type="radio" name="freq" value="on_demand" checked={formData.freq === 'on_demand'} onChange={handleInputChange} className="accent-gray-600" /> 
                                        <span className="text-sm">Solo guardar en Directorio (Sin d√≠a asignado)</span>
                                    </label>
                                </div>
                                <div className="space-y-4">
                                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Fecha (Opcional)</label>
                                    <input type="date" name="specificDate" value={formData.specificDate || ''} onChange={handleInputChange} className="w-full p-3 border rounded-lg bg-gray-50 outline-none dark:bg-gray-800 dark:border-gray-700 dark:text-white" min={new Date().toISOString().split('T')[0]} />
                                </div>
                                <textarea name="notes" value={formData.notes} onChange={handleInputChange} className="w-full p-3 border rounded-lg h-24 dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Notas..." />
                                <div className="flex gap-3"><Button variant="secondary" onClick={() => { setView('list'); resetForm(); }} className="flex-1">Cancelar</Button><Button type="submit" className="flex-1"><Icons.Save /> Guardar</Button></div>
                            </form>
                        )}
                        </>
                        )}

                        {/* ==================== SECCI√ìN: DEUDAS DE CLIENTES ==================== */}
                        {activeSection === 'deudas' && (
                            <div className="space-y-4">
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                                    <div className="flex justify-between items-center mb-3">
                                        <h2 className="text-xl font-bold dark:text-white flex items-center gap-2">
                                            <div className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-1.5 rounded-lg"><Icons.DollarSign size={20} /></div>
                                            Deudas
                                        </h2>
                                        {debts.length > 0 && (
                                            <span className="text-sm font-bold text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-3 py-1 rounded-full">
                                                Total: ${debts.reduce((sum, d) => sum + (d.amount || 0), 0).toLocaleString()}
                                            </span>
                                        )}
                                    </div>
                                    <div className="relative">
                                        <input type="text" placeholder="Buscar por nombre o direcci√≥n..." value={debtSearchTerm} onChange={(e) => setDebtSearchTerm(e.target.value)} className="w-full pl-10 pr-10 py-3 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-lg outline-none dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-sm" />
                                        <div className="absolute left-3 top-3.5 text-gray-400 dark:text-gray-500"><Icons.Search size={18} /></div>
                                        {debtSearchTerm && (
                                            <button onClick={() => setDebtSearchTerm('')} className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><Icons.X size={18} /></button>
                                        )}
                                    </div>
                                </div>

                                {debts.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="bg-gray-100 dark:bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 dark:text-gray-500">
                                            <Icons.DollarSign size={32} />
                                        </div>
                                        <p className="text-gray-500 dark:text-gray-400 font-medium">No hay deudas pendientes</p>
                                        <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">Las deudas se agregan desde la tarjeta del cliente con el bot√≥n $</p>
                                    </div>
                                ) : (
                                    <div className="grid gap-3">
                                        {debts
                                            .filter(d => {
                                                if (!debouncedDebtSearch.trim()) return true;
                                                const term = debouncedDebtSearch.toLowerCase();
                                                return (d.clientName || '').toLowerCase().includes(term) || (d.clientAddress || '').toLowerCase().includes(term);
                                            })
                                            .map(debt => (
                                            <Card key={debt.id} className="p-4 border-l-4 border-l-red-500">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <h3 className="font-bold text-gray-900 dark:text-white">{(debt.clientName || '').toUpperCase()}</h3>
                                                        <div 
                                                            onClick={() => openGoogleMaps(debt.clientLat, debt.clientLng, debt.clientMapsLink)}
                                                            className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 hover:underline mt-0.5"
                                                        >
                                                            <Icons.MapPin size={12} /> {debt.clientAddress}
                                                        </div>
                                                        <p className="text-2xl font-black text-red-600 dark:text-red-400 mt-2">${debt.amount?.toLocaleString()}</p>
                                                        {debt.createdAt && (
                                                            <p className="text-[10px] text-gray-400 dark:text-gray-500 mt-1">
                                                                {new Date(debt.createdAt.seconds ? debt.createdAt.seconds * 1000 : debt.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <div className="flex flex-col gap-2 ml-3">
                                                        <button 
                                                            onClick={() => setConfirmModal({
                                                                isOpen: true,
                                                                title: '¬øDeuda pagada?',
                                                                message: `Confirmar que ${debt.clientName} pag√≥ $${debt.amount?.toLocaleString()}`,
                                                                confirmText: "Pagada",
                                                                isDanger: false,
                                                                action: async () => { await handleDebtPaid(debt); setConfirmModal(prev => ({...prev, isOpen: false})); }
                                                            })}
                                                            className="px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-green-200 dark:hover:bg-green-800"
                                                        >
                                                            <Icons.CheckCircle size={14} /> Pagada
                                                        </button>
                                                        <button 
                                                            onClick={() => setEditDebtModal({ isOpen: true, debt })}
                                                            className="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-gray-200 dark:hover:bg-gray-600"
                                                        >
                                                            <Icons.Edit size={14} /> Editar
                                                        </button>
                                                        {/* Botones WhatsApp */}
                                                        {(() => {
                                                            const client = clients.find(c => c.id === debt.clientId);
                                                            const phone = client?.phone;
                                                            if (!phone) return null;
                                                            return (
                                                                <React.Fragment key={`wa-${debt.id}`}>
                                                                    <button
                                                                        onClick={() => sendWhatsAppDirect(phone)}
                                                                        className="px-3 py-2 bg-green-500 text-white rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-green-600"
                                                                        title="Abrir chat"
                                                                    >
                                                                        <Icons.MessageCircle size={14} /> Chat
                                                                    </button>
                                                                    <button
                                                                        onClick={() => sendDebtReminder(phone)}
                                                                        className="px-3 py-2 bg-orange-500 text-white rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-orange-600"
                                                                        title="Enviar recordatorio de deuda"
                                                                    >
                                                                        <Icons.Send size={14} /> Cobrar
                                                                    </button>
                                                                </React.Fragment>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ==================== SECCI√ìN: REVISAR TRANSFERENCIAS ==================== */}
                        {activeSection === 'transferencias' && (
                            <div className="space-y-4">
                                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                                    <div className="flex justify-between items-center mb-3">
                                        <h2 className="text-xl font-bold dark:text-white flex items-center gap-2">
                                            <div className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 p-1.5 rounded-lg"><Icons.CreditCard size={20} /></div>
                                            Transferencias
                                        </h2>
                                        {transfers.length > 0 && (
                                            <span className="text-sm font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-3 py-1 rounded-full">
                                                {transfers.length} pendiente{transfers.length !== 1 ? 's' : ''}
                                            </span>
                                        )}
                                    </div>
                                    <div className="relative">
                                        <input type="text" placeholder="Buscar por nombre o direcci√≥n..." value={transferSearchTerm} onChange={(e) => setTransferSearchTerm(e.target.value)} className="w-full pl-10 pr-10 py-3 bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-lg outline-none dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-sm" />
                                        <div className="absolute left-3 top-3.5 text-gray-400 dark:text-gray-500"><Icons.Search size={18} /></div>
                                        {transferSearchTerm && (
                                            <button onClick={() => setTransferSearchTerm('')} className="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><Icons.X size={18} /></button>
                                        )}
                                    </div>
                                </div>

                                {transfers.length === 0 ? (
                                    <div className="text-center py-16">
                                        <div className="bg-gray-100 dark:bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 dark:text-gray-500">
                                            <Icons.CreditCard size={32} />
                                        </div>
                                        <p className="text-gray-500 dark:text-gray-400 font-medium">No hay transferencias por revisar</p>
                                        <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">Las transferencias se marcan desde la tarjeta del cliente</p>
                                    </div>
                                ) : (
                                    <div className="grid gap-3">
                                        {transfers
                                            .filter(t => {
                                                if (!debouncedTransferSearch.trim()) return true;
                                                const term = debouncedTransferSearch.toLowerCase();
                                                return (t.clientName || '').toLowerCase().includes(term) || (t.clientAddress || '').toLowerCase().includes(term);
                                            })
                                            .map(transfer => (
                                            <Card key={transfer.id} className="p-4 border-l-4 border-l-emerald-500">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex-1">
                                                        <h3 className="font-bold text-gray-900 dark:text-white">{(transfer.clientName || '').toUpperCase()}</h3>
                                                        <div 
                                                            onClick={() => openGoogleMaps(transfer.clientLat, transfer.clientLng, transfer.clientMapsLink)}
                                                            className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1 cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 hover:underline mt-0.5"
                                                        >
                                                            <Icons.MapPin size={12} /> {transfer.clientAddress}
                                                        </div>
                                                        {transfer.createdAt && (
                                                            <p className="text-[10px] text-gray-400 dark:text-gray-500 mt-1">
                                                                {new Date(transfer.createdAt.seconds ? transfer.createdAt.seconds * 1000 : transfer.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <button 
                                                        onClick={() => handleTransferReviewed(transfer)}
                                                        className="px-4 py-2.5 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-lg text-sm font-bold flex items-center gap-1.5 hover:bg-emerald-200 dark:hover:bg-emerald-800 ml-3"
                                                    >
                                                        <Icons.CheckCircle size={16} /> Revisada
                                                    </button>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* NAV - Solo visible en secci√≥n Cartera */}
                    {activeSection === 'cartera' && (
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700 flex justify-around p-2 z-20 pb-safe shadow-lg transition-colors duration-200">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center p-2 rounded-lg ${view === 'list' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'}`}><Icons.Home /><span className="text-xs font-medium">Inicio</span></button>
                        {isAdmin ? (
                            <button onClick={() => { resetForm(); setView('add'); }} className="relative group flex items-center justify-center w-20" aria-label="Nuevo Cliente">
                                <div className="absolute -top-8 bg-blue-600 hover:bg-blue-500 text-white rounded-full w-[80px] h-[80px] flex items-center justify-center shadow-2xl border-[6px] border-white dark:border-gray-900 transition-all duration-300 transform group-active:scale-95">
                                    <Icons.Plus size={40} strokeWidth={3} />
                                </div>
                            </button>
                        ) : (
                            <div className="w-20" /> 
                        )}
                        <button onClick={() => setView('directory')} className={`flex flex-col items-center p-2 rounded-lg ${view === 'directory' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'}`}><Icons.Users /><span className="text-xs font-medium">Directorio</span></button>
                    </nav>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>