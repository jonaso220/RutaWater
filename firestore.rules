rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuth() {
      return request.auth != null;
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isGroupAdmin() {
      return userExists() && getUserData().role == 'admin';
    }

    // Acceso de lectura: dueño del doc O mismo grupo
    function hasAccess(res) {
      return res.data.userId == request.auth.uid
        || (userExists() && getUserData().groupId != null && res.data.groupId == getUserData().groupId);
    }

    // Acceso de escritura: dueño del doc O admin del mismo grupo
    function hasWriteAccess(res) {
      return res.data.userId == request.auth.uid
        || (userExists() && getUserData().groupId != null && res.data.groupId == getUserData().groupId && getUserData().role == 'admin');
    }

    function isOwnData() {
      return request.resource.data.userId == request.auth.uid;
    }

    // --- CLIENTS ---
    match /clients/{clientId} {
      allow read: if isAuth() && hasAccess(resource);
      allow create: if isAuth() && isOwnData()
        && request.resource.data.name is string
        && request.resource.data.name.size() <= 100
        && request.resource.data.address is string
        && request.resource.data.address.size() <= 200;
      allow update: if isAuth() && hasAccess(resource) && (
        hasWriteAccess(resource) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'isCompleted', 'completedAt', 'updatedAt', 'alarm', 'isStarred',
          'lastVisited', 'specificDate', 'hasDebt', 'hasPendingTransfer'
        ])
      );
      allow delete: if isAuth() && hasWriteAccess(resource);
    }

    // --- DEBTS ---
    match /debts/{debtId} {
      allow read: if isAuth() && hasAccess(resource);
      allow create: if isAuth() && isOwnData()
        && request.resource.data.amount is number
        && request.resource.data.amount > 0
        && request.resource.data.clientName is string;
      allow update: if isAuth() && hasAccess(resource)
        && request.resource.data.amount is number
        && request.resource.data.amount > 0;
      allow delete: if isAuth() && hasAccess(resource);
    }

    // --- TRANSFERS ---
    match /transfers/{transferId} {
      allow read: if isAuth() && hasAccess(resource);
      allow create: if isAuth() && isOwnData()
        && request.resource.data.clientName is string;
      allow update: if isAuth() && hasAccess(resource);
      allow delete: if isAuth() && hasAccess(resource);
    }

    // --- USERS ---
    match /users/{userId} {
      allow read: if isAuth() && (
        userId == request.auth.uid ||
        (resource.data.groupId != null && userExists() && getUserData().groupId == resource.data.groupId)
      );
      allow create: if isAuth() && userId == request.auth.uid;
      allow update: if isAuth() && (
        userId == request.auth.uid ||
        (isGroupAdmin() && getUserData().groupId == resource.data.groupId)
      );
      allow delete: if false;
    }

    // --- GROUPS ---
    match /groups/{groupId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.resource.data.adminId == request.auth.uid;
      allow update: if isAuth() && resource.data.adminId == request.auth.uid;
      allow delete: if isAuth() && resource.data.adminId == request.auth.uid;
    }

    // --- DAILY_LOADS ---
    match /daily_loads/{loadId} {
      allow read: if isAuth() && hasAccess(resource);
      allow create: if isAuth() && isOwnData();
      allow update: if isAuth() && hasAccess(resource);
      allow delete: if isAuth() && hasWriteAccess(resource);
    }

    // --- BLOQUEAR TODO LO DEMÁS ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
